<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketPlace Inverso | Conectando Compradores y Vendedores</title>
    <link rel="manifest" id="manifest-placeholder">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîÑ</text></svg>">
    <style>
        /* RESET Y ESTILOS BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --primary-light: #edf2ff;
            --secondary: #7209b7;
            --secondary-dark: #5a0792;
            --success: #4cc9f0;
            --success-dark: #2da9d1;
            --warning: #f72585;
            --warning-dark: #d1146e;
            --danger: #ef233c;
            --danger-dark: #d21430;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --gray-dark: #495057;
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
            --transition-fast: all 0.15s ease;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 80px; /* Espacio para men√∫ m√≥vil */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* UTILIDADES */
        .hidden {
            display: none !important;
        }

        .view {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 28px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            gap: 8px;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success);
            color: var(--dark);
        }

        .btn-success:hover {
            background-color: var(--success-dark);
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: var(--warning-dark);
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
            transform: translateY(-2px);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-sm {
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .btn-xs {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: var(--border-radius-sm);
        }

        .btn-block {
            width: 100%;
        }

        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .badge-success {
            background-color: rgba(76, 201, 240, 0.15);
            color: #1a7a8f;
            border-color: rgba(76, 201, 240, 0.3);
        }

        .badge-warning {
            background-color: rgba(247, 37, 133, 0.15);
            color: #a3164d;
            border-color: rgba(247, 37, 133, 0.3);
        }

        .badge-danger {
            background-color: rgba(239, 35, 60, 0.15);
            color: #b91c2c;
            border-color: rgba(239, 35, 60, 0.3);
        }

        .badge-info {
            background-color: rgba(67, 97, 238, 0.15);
            color: var(--primary-dark);
            border-color: rgba(67, 97, 238, 0.3);
        }

        .badge-light {
            background-color: rgba(248, 249, 250, 0.8);
            color: var(--gray-dark);
            border-color: rgba(0,0,0,0.1);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--gray);
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* HEADER Y NAVEGACI√ìN */
        header {
            background-color: white;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--primary);
            text-decoration: none;
        }

        .logo-icon {
            font-size: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .desktop-nav {
            display: none;
        }

        .desktop-nav a {
            margin-left: 24px;
            color: var(--dark);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            padding: 8px 0;
        }

        .desktop-nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary);
            transition: var(--transition);
        }

        .desktop-nav a:hover::after,
        .desktop-nav a.active-nav::after {
            width: 100%;
        }

        .desktop-nav a:hover {
            color: var(--primary);
        }

        .desktop-nav a.active-nav {
            color: var(--primary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
            cursor: pointer;
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--warning);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
        }

        /* MEN√ö M√ìVIL */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.98);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 90;
            backdrop-filter: blur(10px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            font-size: 0.8rem;
            gap: 6px;
            transition: var(--transition);
            position: relative;
            padding: 8px;
        }

        .nav-item.active {
            color: var(--primary);
            transform: translateY(-2px);
        }

        .nav-item i {
            font-size: 22px;
        }

        .nav-notification {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--warning);
        }

        /* LANDING PAGE */
        #landing {
            padding-top: 40px;
        }

        .hero {
            text-align: center;
            padding: 80px 0;
            max-width: 900px;
            margin: 0 auto;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 24px;
            color: var(--dark);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .hero p {
            font-size: 1.3rem;
            color: var(--gray);
            margin-bottom: 48px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .features {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 80px;
        }

        .feature {
            text-align: center;
            padding: 40px 30px;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .feature:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }

        .feature-icon {
            font-size: 48px;
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .feature h3 {
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: var(--dark);
        }

        /* AUTENTICACI√ìN */
        .auth-form {
            max-width: 500px;
            margin: 60px auto;
        }

        .auth-form h2 {
            margin-bottom: 30px;
            text-align: center;
            font-size: 2rem;
            color: var(--dark);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: 24px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 12px 20px;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            transition: var(--transition);
            flex: 1;
        }

        .radio-option:hover {
            border-color: var(--primary);
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-option input[type="radio"]:checked + .radio-custom {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .radio-option input[type="radio"]:checked + .radio-custom::after {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
        }

        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* DASHBOARDS */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .dashboard-title {
            font-size: 2rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dashboard-title-icon {
            font-size: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, white, var(--primary-light));
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid rgba(67, 97, 238, 0.1);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
            line-height: 1;
        }

        .stat-label {
            color: var(--gray);
            font-size: 1rem;
            font-weight: 600;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title-icon {
            font-size: 24px;
        }

        /* TARJETAS DE AVISOS Y PROPUESTAS */
        .avisos-grid, .propuestas-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        .aviso-card, .propuesta-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            position: relative;
        }

        .aviso-card:hover, .propuesta-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(67, 97, 238, 0.2);
        }

        .aviso-header, .propuesta-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .aviso-title, .propuesta-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1.3;
        }

        .aviso-meta, .propuesta-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            color: var(--gray);
            font-size: 0.95rem;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-light);
        }

        .aviso-description, .propuesta-description {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .aviso-actions, .propuesta-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .aviso-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* DETALLE AVISO */
        .detalle-aviso-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .detalle-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 30px;
            flex-wrap: wrap;
        }

        .detalle-info {
            flex: 1;
            min-width: 300px;
        }

        .detalle-sidebar {
            width: 350px;
        }

        .detalle-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 35px;
            box-shadow: var(--shadow);
        }

        .detalle-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 20px;
            line-height: 1.3;
        }

        .detalle-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .meta-card {
            background: var(--primary-light);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid rgba(67, 97, 238, 0.1);
        }

        .meta-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .meta-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .detalle-description {
            font-size: 1.1rem;
            line-height: 1.7;
            color: var(--dark);
            margin: 30px 0;
            white-space: pre-line;
        }

        /* SECCI√ìN PROPUESTAS EN DETALLE */
        .propuestas-section {
            margin-top: 40px;
        }

        .propuesta-item {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        .propuesta-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .propuesta-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .propuesta-item-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .propuesta-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .propuesta-item-content {
            margin: 20px 0;
            padding: 20px;
            background: var(--primary-light);
            border-radius: var(--border-radius-sm);
            border-left: 4px solid var(--primary);
        }

        .propuesta-item-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* SECCI√ìN CHAT EN DETALLE */
        .chat-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .chat-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: #f9f9f9;
        }

        .message {
            max-width: 75%;
            padding: 16px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-received {
            align-self: flex-start;
            background: white;
            color: var(--dark);
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .message-sender {
            font-weight: 700;
        }

        .message-time {
            opacity: 0.7;
            font-size: 0.75rem;
        }

        .message-content {
            line-height: 1.5;
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid var(--gray-light);
            display: flex;
            gap: 15px;
        }

        .chat-input {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        /* ESTADOS */
        .estados-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .estado-badge-large {
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 700;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .estado-icon {
            font-size: 1.2rem;
        }

        /* FILTROS */
        .filters {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        /* NUEVOS ESTILOS PARA FILTROS INMOBILIARIOS */
        .filter-category {
            background: var(--primary-light);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }

        .filter-category-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .characteristics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .characteristic-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .characteristic-checkbox:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .characteristic-checkbox input[type="checkbox"] {
            margin: 0;
        }

        .price-range {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .price-range input {
            flex: 1;
        }

        .price-range-separator {
            color: var(--gray);
            font-weight: 600;
        }

        /* PANEL ADMIN */
        .admin-section {
            margin-bottom: 50px;
        }

        .admin-section h3 {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
            font-size: 1.5rem;
            color: var(--dark);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .data-table th, .data-table td {
            padding: 18px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }

        .data-table th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 700;
            font-size: 1rem;
        }

        .data-table tr:hover {
            background-color: rgba(67, 97, 238, 0.03);
        }

        /* INSTALAR PWA */
        #install-pwa {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            animation: slideInUp 0.5s ease;
        }

        /* ANIMACIONES */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* MODALES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideInUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger);
        }

        /* NOTIFICACIONES */
        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
            transition: var(--transition);
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: var(--primary-light);
        }

        .notification-icon {
            font-size: 24px;
            color: var(--primary);
        }

        .notification-content {
            flex: 1;
        }

        .notification-time {
            font-size: 0.85rem;
            color: var(--gray);
        }

        /* RESPONSIVE */
        @media (min-width: 768px) {
            .desktop-nav {
                display: flex;
            }
            
            .mobile-nav {
                display: none;
            }
            
            body {
                padding-bottom: 0;
            }
            
            .features {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .avisos-grid, .propuestas-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .detalle-aviso-container {
                flex-direction: row;
            }
            
            .detalle-sidebar {
                width: 400px;
            }
            
            .characteristics-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (min-width: 992px) {
            .avisos-grid, .propuestas-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .detalle-sidebar {
                width: 450px;
            }
            
            .filters-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .avisos-grid, .propuestas-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* LOADING */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="container header-content">
            <a href="#" class="logo" onclick="showView('landing'); return false;">
                <span class="logo-icon">üîÑ</span>
                <span>MarketConnect</span>
            </a>
            
            <nav class="desktop-nav">
                <a href="#" onclick="showView('dashboard'); return false;" id="nav-dashboard" class="hidden">Dashboard</a>
                <a href="#" onclick="showView('avisos'); return false;" id="nav-avisos" class="hidden">Avisos</a>
                <a href="#" onclick="showView('propuestas'); return false;" id="nav-propuestas" class="hidden">Propuestas</a>
                <a href="#" onclick="showView('chats'); return false;" id="nav-chats" class="hidden">
                    üí¨ Chats
                    <span id="unread-chat-count" class="notification-badge hidden">0</span>
                </a>
                <a href="#" onclick="showView('perfil'); return false;" id="nav-perfil" class="hidden">Perfil</a>
                <a href="#" onclick="showView('admin'); return false;" id="nav-admin" class="hidden">Admin</a>
            </nav>
            
            <div class="user-menu">
                <div id="user-info" class="hidden">
                    <span id="user-role-badge" class="badge"></span>
                </div>
                <div id="user-avatar-container" style="position: relative;">
                    <div id="user-avatar" class="user-avatar hidden" onclick="toggleUserMenu()"></div>
                    <span id="notification-count" class="notification-badge hidden">0</span>
                    <div id="user-dropdown" class="card hidden" style="position: absolute; top: 60px; right: 0; width: 250px; z-index: 1001;">
                        <div style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <div id="dropdown-avatar" class="user-avatar"></div>
                                <div>
                                    <div id="dropdown-email" style="font-weight: 600; margin-bottom: 5px;"></div>
                                    <div id="dropdown-role" class="badge"></div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <button class="btn btn-sm btn-outline" onclick="showView('perfil'); toggleUserMenu()">Mi Perfil</button>
                                <button class="btn btn-sm btn-outline" onclick="showView('chats'); toggleUserMenu()">
                                    üí¨ Mis Chats
                                    <span id="dropdown-chat-count" class="badge badge-warning hidden" style="margin-left: auto;">0</span>
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="toggleNotifications(); toggleUserMenu()">
                                    üîî Notificaciones
                                    <span id="dropdown-notif-count" class="badge badge-warning hidden" style="margin-left: auto;">0</span>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="login-btn" class="btn btn-primary" onclick="showView('login')">Iniciar Sesi√≥n</button>
                <button id="logout-btn" class="btn btn-outline hidden" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </header>

    <!-- VISTAS -->
    <main class="container">
        <!-- LANDING -->
        <section id="landing" class="view active">
            <div class="hero">
                <h1>Conectamos lo que buscas con quien lo ofrece</h1>
                <p>Publica lo que necesitas y deja que los mejores vendedores compitan por ofrecerte la mejor soluci√≥n. Tu demanda, nuestras propuestas.</p>
                <div class="hero-actions">
                    <button class="btn btn-primary btn-lg" onclick="showView('register')">
                        <span>üöÄ</span> Comenzar Gratis
                    </button>
                    <button class="btn btn-secondary btn-lg" onclick="showView('login')">
                        <span>üîë</span> Iniciar Sesi√≥n
                    </button>
                    <button class="btn btn-outline btn-lg" onclick="scrollToFeatures()">
                        <span>‚ú®</span> C√≥mo Funciona
                    </button>
                </div>
            </div>
            
            <div class="features" id="features-section">
                <div class="feature">
                    <div class="feature-icon">üìù</div>
                    <h3>Crea tu Aviso</h3>
                    <p>Describe exactamente lo que necesitas con todos los detalles importantes. Cuanto m√°s espec√≠fico seas, mejores propuestas recibir√°s.</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">üèÜ</div>
                    <h3>Recibe Propuestas</h3>
                    <p>Los vendedores competir√°n para ofrecerte la mejor soluci√≥n. Recibe m√∫ltiples opciones y compara precios, condiciones y calidad.</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">ü§ù</div>
                    <h3>Negocia Directo</h3>
                    <p>Chat integrado para aclarar dudas, negociar condiciones y cerrar el trato perfecto. Todo en un solo lugar, sin intermediarios.</p>
                </div>
            </div>
        </section>

        <!-- LOGIN -->
        <section id="login" class="view">
            <div class="auth-form card">
                <h2>Iniciar Sesi√≥n</h2>
                <form id="login-form" onsubmit="login(event)">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" class="form-control" placeholder="tu@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Contrase√±a</label>
                        <input type="password" id="login-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <div class="form-group" style="text-align: right;">
                        <a href="#" onclick="showPasswordReset()" style="font-size: 0.9rem; color: var(--primary);">¬øOlvidaste tu contrase√±a?</a>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Ingresar</button>
                </form>
                <div style="text-align: center; margin-top: 30px; padding-top: 30px; border-top: 1px solid var(--gray-light);">
                    <p style="margin-bottom: 20px; color: var(--gray);">¬øNo tienes cuenta?</p>
                    <button class="btn btn-secondary" onclick="showView('register')">Crear Cuenta Gratis</button>
                </div>
            </div>
        </section>

        <!-- REGISTRO -->
        <section id="register" class="view">
            <div class="auth-form card">
                <h2>Crear Cuenta</h2>
                <form id="register-form" onsubmit="register(event)">
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" class="form-control" placeholder="tu@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Contrase√±a</label>
                        <input type="password" id="register-password" class="form-control" placeholder="M√≠nimo 6 caracteres" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="register-name">Nombre (opcional)</label>
                        <input type="text" id="register-name" class="form-control" placeholder="C√≥mo quieres que te llamen">
                    </div>
                    <div class="form-group">
                        <label>¬øQu√© quieres hacer en la plataforma?</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="role" value="comprador" checked>
                                <div class="radio-custom"></div>
                                <span>Buscar productos/servicios</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="role" value="vendedor">
                                <div class="radio-custom"></div>
                                <span>Ofrecer productos/servicios</span>
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Crear Cuenta</button>
                </form>
                <p style="text-align: center; margin-top: 30px;">
                    ¬øYa tienes cuenta? <a href="#" onclick="showView('login')" style="color: var(--primary); font-weight: 600;">Inicia sesi√≥n aqu√≠</a>
                </p>
            </div>
        </section>

        <!-- DASHBOARD -->
        <section id="dashboard" class="view">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <span class="dashboard-title-icon">üìä</span>
                    <span id="dashboard-title-text">Mi Dashboard</span>
                </div>
                <div>
                    <button id="create-aviso-btn" class="btn btn-primary hidden" onclick="showCreateAvisoModal()">
                        <span>‚ûï</span> Crear Nuevo Aviso
                    </button>
                    <button class="btn btn-outline" onclick="refreshDashboard()">
                        <span>üîÑ</span> Actualizar
                    </button>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="stat-avisos-activos">0</div>
                    <div class="stat-label">Avisos Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-propuestas-total">0</div>
                    <div class="stat-label">Propuestas Recibidas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-chats-activos">0</div>
                    <div class="stat-label">Chats Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-negociaciones">0</div>
                    <div class="stat-label">En Negociaci√≥n</div>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div>
                    <h3 class="section-title">
                        <span class="section-title-icon">üìù</span>
                        Mis Avisos Recientes
                    </h3>
                    <div id="dashboard-avisos" class="avisos-grid">
                        <!-- Se llena din√°micamente -->
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-outline" onclick="showView('avisos')">Ver Todos los Avisos</button>
                    </div>
                </div>
                
                <div style="margin-top: 40px;">
                    <h3 class="section-title">
                        <span class="section-title-icon">üì®</span>
                        Propuestas Recientes
                    </h3>
                    <div id="dashboard-propuestas" class="propuestas-grid">
                        <!-- Se llena din√°micamente -->
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-outline" onclick="showView('propuestas')">Ver Todas las Propuestas</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- AVISOS -->
        <section id="avisos" class="view">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <span class="dashboard-title-icon">üìã</span>
                    <span id="avisos-title">Avisos</span>
                </div>
                <div>
                    <button id="filter-toggle" class="btn btn-outline" onclick="toggleFilters()">
                        <span>üîç</span> Filtros
                    </button>
                    <button id="create-aviso-btn-2" class="btn btn-primary hidden" onclick="showCreateAvisoModal()">
                        <span>‚ûï</span> Nuevo Aviso
                    </button>
                </div>
            </div>
            
            <div id="filters-container" class="filters hidden">
                <div class="filters-header">
                    <h3 style="margin: 0;">Filtrar Avisos</h3>
                    <button class="btn btn-xs" onclick="limpiarFiltros()">Limpiar Filtros</button>
                </div>
                <div class="filters-grid">
                    <div>
                        <label>Tipo</label>
                        <select id="filter-tipo" class="form-control" onchange="toggleFiltrosEspecificos()">
                            <option value="">Todos los tipos</option>
                            <option value="inmueble">üè† Inmueble</option>
                            <option value="auto">üöó Automotor</option>
                            <option value="motos">üèçÔ∏è Motos</option>
                            <option value="tecnologia">üíª Tecnolog√≠a</option>
                            <option value="servicios">üîß Servicios</option>
                            <option value="otros">üì¶ Otros</option>
                        </select>
                    </div>
                    <div>
                        <label>Presupuesto m√°ximo</label>
                        <input type="number" id="filter-presupuesto" class="form-control" placeholder="USD">
                    </div>
                    <div>
                        <label>Estado</label>
                        <select id="filter-estado" class="form-control">
                            <option value="">Todos los estados</option>
                            <option value="abierto">Abierto</option>
                            <option value="negociando">Negociando</option>
                            <option value="cerrado">Cerrado</option>
                            <option value="rechazado">Rechazado</option>
                        </select>
                    </div>
                    <div>
                        <label>Urgencia</label>
                        <select id="filter-urgencia" class="form-control">
                            <option value="">Cualquier urgencia</option>
                            <option value="baja">Baja</option>
                            <option value="media">Media</option>
                            <option value="alta">Alta</option>
                            <option value="inmediata">Inmediata</option>
                        </select>
                    </div>
                </div>
                
                <!-- FILTROS ESPEC√çFICOS PARA INMUEBLES -->
                <div id="inmueble-filters" class="hidden">
                    <div class="filter-category">
                        <div class="filter-category-title">
                            <span>üè¢</span>
                            <span>Filtros Espec√≠ficos para Inmuebles</span>
                        </div>
                        <div class="filters-grid">
                            <div>
                                <label>Operaci√≥n</label>
                                <select id="filter-inmueble-operacion" class="form-control">
                                    <option value="">Todas las operaciones</option>
                                    <option value="venta">Venta</option>
                                    <option value="arriendo">Arriendo</option>
                                    <option value="arriendo_temporal">Arriendo Temporal</option>
                                    <option value="proyecto_nuevo">Proyecto Nuevo</option>
                                </select>
                            </div>
                            <div>
                                <label>Tipo de Inmueble</label>
                                <select id="filter-inmueble-tipo" class="form-control">
                                    <option value="">Todos los tipos</option>
                                    <option value="departamento">Departamento</option>
                                    <option value="casa">Casa</option>
                                    <option value="oficina">Oficina</option>
                                    <option value="local_comercial">Local Comercial</option>
                                    <option value="terreno">Terreno</option>
                                    <option value="parcela">Parcela</option>
                                    <option value="bodega">Bodega</option>
                                    <option value="estacionamiento">Estacionamiento</option>
                                    <option value="industrial">Industrial</option>
                                    <option value="agricola">Agr√≠cola</option>
                                </select>
                            </div>
                            <div>
                                <label>Regi√≥n</label>
                                <select id="filter-inmueble-region" class="form-control" onchange="cargarComunasFiltro()">
                                    <option value="">Todas las regiones</option>
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                            <div>
                                <label>Comuna</label>
                                <select id="filter-inmueble-comuna" class="form-control">
                                    <option value="">Todas las comunas</option>
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                            <div>
                                <label>Dormitorios</label>
                                <select id="filter-inmueble-dormitorios" class="form-control">
                                    <option value="">Cualquier cantidad</option>
                                    <option value="0">Studio</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5 o m√°s</option>
                                </select>
                            </div>
                            <div>
                                <label>Ba√±os</label>
                                <select id="filter-inmueble-banos" class="form-control">
                                    <option value="">Cualquier cantidad</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4 o m√°s</option>
                                </select>
                            </div>
                            <div>
                                <label>Superficie √∫til (m¬≤)</label>
                                <div class="price-range">
                                    <input type="number" id="filter-inmueble-sup-util-min" class="form-control" placeholder="M√≠n">
                                    <span class="price-range-separator">a</span>
                                    <input type="number" id="filter-inmueble-sup-util-max" class="form-control" placeholder="M√°x">
                                </div>
                            </div>
                            <div>
                                <label>Superficie total (m¬≤)</label>
                                <div class="price-range">
                                    <input type="number" id="filter-inmueble-sup-total-min" class="form-control" placeholder="M√≠n">
                                    <span class="price-range-separator">a</span>
                                    <input type="number" id="filter-inmueble-sup-total-max" class="form-control" placeholder="M√°x">
                                </div>
                            </div>
                        </div>
                        
                        <!-- CARACTER√çSTICAS -->
                        <div class="filter-category" style="margin-top: 20px;">
                            <div class="filter-category-title">
                                <span>‚≠ê</span>
                                <span>Caracter√≠sticas</span>
                            </div>
                            <div class="characteristics-grid">
                                <label class="characteristic-checkbox">
                                    <input type="checkbox" id="filter-inmueble-estacionamiento" value="estacionamiento">
                                    <span>Estacionamiento</span>
                                </label>
                                <label class="characteristic-checkbox">
                                    <input type="checkbox" id="filter-inmueble-bodega" value="bodega">
                                    <span>Bodega</span>
                                </label>
                                <label class="characteristic-checkbox">
                                    <input type="checkbox" id="filter-inmueble-terraza" value="terraza">
                                    <span>Terraza</span>
                                </label>
                                <label class="characteristic-checkbox">
                                    <input type="checkbox" id="filter-inmueble-piscina" value="piscina">
                                    <span>Piscina</span>
                                </label>
                                <label class="characteristic-checkbox">
                                    <input type="checkbox" id="filter-inmueble-quincho" value="quincho">
                                    <span>Quincho</span>
                                </label>
                                <label class="characteristic-checkbox">
                                    <input type="checkbox" id="filter-inmueble-areas_verdes" value="areas_verdes">
                                    <span>√Åreas Verdes</span>
                                </label>
                                <label class="characteristic-checkbox">
                                    <input type="checkbox" id="filter-inmueble-gimnasio" value="gimnasio">
                                    <span>Gimnasio</span>
                                </label>
                                <label class="characteristic-checkbox">
                                    <input type="checkbox" id="filter-inmueble-seguridad" value="seguridad">
                                    <span>Seguridad 24/7</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="aplicarFiltros()">Aplicar Filtros</button>
                </div>
            </div>
            
            <div id="avisos-list" class="avisos-grid">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- DETALLE AVISO -->
        <section id="detalle-aviso" class="view">
            <div id="detalle-aviso-content" class="detalle-aviso-container">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- PROPUESTAS -->
        <section id="propuestas" class="view">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <span class="dashboard-title-icon">üì®</span>
                    <span id="propuestas-title">Propuestas</span>
                </div>
                <div>
                    <button class="btn btn-outline" onclick="togglePropuestasFilters()">
                        <span>üîç</span> Filtros
                    </button>
                </div>
            </div>
            
            <div id="propuestas-filters" class="filters hidden">
                <div class="filters-header">
                    <h3 style="margin: 0;">Filtrar Propuestas</h3>
                    <button class="btn btn-xs" onclick="limpiarPropuestasFiltros()">Limpiar</button>
                </div>
                <div class="filters-grid">
                    <div>
                        <label>Estado</label>
                        <select id="filter-propuesta-estado" class="form-control">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="aceptada">Aceptada</option>
                            <option value="rechazada">Rechazada</option>
                            <option value="negociando">Negociando</option>
                        </select>
                    </div>
                    <div>
                        <label>Tipo de aviso</label>
                        <select id="filter-propuesta-tipo" class="form-control">
                            <option value="">Todos los tipos</option>
                            <option value="inmueble">üè† Inmueble</option>
                            <option value="auto">üöó Automotor</option>
                            <option value="motos">üèçÔ∏è Motos</option>
                            <option value="tecnologia">üíª Tecnolog√≠a</option>
                            <option value="servicios">üîß Servicios</option>
                            <option value="otros">üì¶ Otros</option>
                        </select>
                    </div>
                    <div>
                        <label>Ordenar por</label>
                        <select id="filter-propuesta-orden" class="form-control">
                            <option value="fecha">M√°s recientes</option>
                            <option value="precio_asc">Precio m√°s bajo</option>
                            <option value="precio_desc">Precio m√°s alto</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="aplicarPropuestasFiltros()">Aplicar Filtros</button>
                </div>
            </div>
            
            <div id="propuestas-list" class="propuestas-grid">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- CHATS -->
        <section id="chats" class="view">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <span class="dashboard-title-icon">üí¨</span>
                    <span>Mis Conversaciones</span>
                </div>
                <div id="unread-chats-badge" class="badge badge-warning hidden" style="font-size: 1rem;">
                    <span id="unread-chats-count">0</span> mensajes nuevos
                </div>
            </div>
            
            <div id="chats-list" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- PERFIL -->
        <section id="perfil" class="view">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <span class="dashboard-title-icon">üë§</span>
                    <span>Mi Perfil</span>
                </div>
                <button class="btn btn-outline" onclick="editarPerfil()">
                    <span>‚úèÔ∏è</span> Editar Perfil
                </button>
            </div>
            
            <div id="profile-content" class="detalle-content">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- PANEL ADMIN -->
        <section id="admin" class="view">
            <div class="dashboard-header">
                <h2 class="dashboard-title">
                    <span class="dashboard-title-icon">‚öôÔ∏è</span>
                    Panel de Administraci√≥n
                </h2>
                <div>
                    <button class="btn btn-warning" onclick="generarReporte()">
                        <span>üìä</span> Generar Reporte
                    </button>
                    <button class="btn btn-danger" onclick="resetSystem()">
                        <span>üîÅ</span> Resetear Sistema
                    </button>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="admin-total-users">0</div>
                    <div class="stat-label">Usuarios Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="admin-total-avisos">0</div>
                    <div class="stat-label">Avisos Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="admin-total-propuestas">0</div>
                    <div class="stat-label">Propuestas Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="admin-total-chats">0</div>
                    <div class="stat-label">Conversaciones</div>
                </div>
            </div>
            
            <div class="admin-section">
                <h3>Usuarios Registrados</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Email</th>
                                <th>Nombre</th>
                                <th>Rol</th>
                                <th>Registro</th>
                                <th>Avisos</th>
                                <th>Propuestas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-list">
                            <!-- Se llena din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-section">
                <h3>Todos los Avisos</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√≠tulo</th>
                                <th>Tipo</th>
                                <th>Usuario</th>
                                <th>Presupuesto</th>
                                <th>Estado</th>
                                <th>Propuestas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-avisos-list">
                            <!-- Se llena din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-section">
                <h3>Todas las Propuestas</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Aviso</th>
                                <th>Vendedor</th>
                                <th>Precio</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-propuestas-list">
                            <!-- Se llena din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- MEN√ö M√ìVIL -->
    <nav class="mobile-nav">
        <a href="#" class="nav-item" onclick="showView('dashboard')">
            <span>üìä</span>
            <span>Dashboard</span>
        </a>
        <a href="#" class="nav-item" onclick="showView('avisos')">
            <span>üìù</span>
            <span>Avisos</span>
        </a>
        <a href="#" class="nav-item" onclick="showCreateAvisoModal()">
            <span>‚ûï</span>
            <span>Nuevo</span>
        </a>
        <a href="#" class="nav-item" onclick="showView('chats')">
            <span>üí¨</span>
            <span>Chats</span>
            <span id="mobile-chat-notification" class="nav-notification hidden"></span>
        </a>
        <a href="#" class="nav-item" onclick="showView('perfil')">
            <span>üë§</span>
            <span>Perfil</span>
        </a>
    </nav>

    <!-- BOT√ìN INSTALAR PWA -->
    <div id="install-pwa" class="hidden">
        <button id="install-btn" class="btn btn-primary" style="box-shadow: 0 6px 20px rgba(0,0,0,0.2);">
            <span>‚¨áÔ∏è</span> Instalar App
        </button>
    </div>

    <!-- MODALES -->
    <div id="create-aviso-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Crear Nuevo Aviso</h2>
                <button class="modal-close" onclick="closeModal('create-aviso-modal')">√ó</button>
            </div>
            <form id="create-aviso-form" onsubmit="crearAviso(event)">
                <div class="form-group">
                    <label for="aviso-titulo">T√≠tulo del aviso *</label>
                    <input type="text" id="aviso-titulo" class="form-control" placeholder="Ej: Busco apartamento de 2 habitaciones en zona centro" required>
                </div>
                
                <div class="form-group">
                    <label for="aviso-tipo">Tipo *</label>
                    <select id="aviso-tipo" class="form-control" required onchange="toggleCamposEspecificos()">
                        <option value="">Selecciona un tipo</option>
                        <option value="inmueble">üè† Inmueble</option>
                        <option value="auto">üöó Automotor</option>
                        <option value="motos">üèçÔ∏è Motos</option>
                        <option value="tecnologia">üíª Tecnolog√≠a</option>
                        <option value="servicios">üîß Servicios</option>
                        <option value="otros">üì¶ Otros</option>
                    </select>
                </div>
                
                <!-- CAMPOS ESPEC√çFICOS PARA INMUEBLES -->
                <div id="campos-inmueble" class="hidden">
                    <div class="form-group">
                        <label for="aviso-operacion">Operaci√≥n *</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="operacion" value="venta" checked>
                                <div class="radio-custom"></div>
                                <span>Venta</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="operacion" value="arriendo">
                                <div class="radio-custom"></div>
                                <span>Arriendo</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="operacion" value="arriendo_temporal">
                                <div class="radio-custom"></div>
                                <span>Arriendo Temporal</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="operacion" value="proyecto_nuevo">
                                <div class="radio-custom"></div>
                                <span>Proyecto Nuevo</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-tipo-inmueble">Tipo de Inmueble *</label>
                        <select id="aviso-tipo-inmueble" class="form-control">
                            <option value="departamento">Departamento</option>
                            <option value="casa">Casa</option>
                            <option value="oficina">Oficina</option>
                            <option value="local_comercial">Local Comercial</option>
                            <option value="terreno">Terreno</option>
                            <option value="parcela">Parcela</option>
                            <option value="bodega">Bodega</option>
                            <option value="estacionamiento">Estacionamiento</option>
                            <option value="industrial">Industrial</option>
                            <option value="agricola">Agr√≠cola</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-region">Regi√≥n *</label>
                        <select id="aviso-region" class="form-control" onchange="cargarComunas()">
                            <option value="">Selecciona una regi√≥n</option>
                            <!-- Se llena din√°micamente -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-comuna">Comuna *</label>
                        <select id="aviso-comuna" class="form-control" onchange="cargarBarrios()">
                            <option value="">Selecciona una comuna</option>
                            <!-- Se llena din√°micamente -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-barrio">Barrio (opcional)</label>
                        <select id="aviso-barrio" class="form-control">
                            <option value="">Selecciona un barrio</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-dormitorios">Dormitorios *</label>
                        <select id="aviso-dormitorios" class="form-control">
                            <option value="0">Studio</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5 o m√°s</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-banos">Ba√±os *</label>
                        <select id="aviso-banos" class="form-control">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4 o m√°s</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-superficie-util">Superficie √∫til (m¬≤) *</label>
                        <input type="number" id="aviso-superficie-util" class="form-control" min="0" step="1" placeholder="Ej: 80">
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-superficie-total">Superficie total (m¬≤) *</label>
                        <input type="number" id="aviso-superficie-total" class="form-control" min="0" step="1" placeholder="Ej: 100">
                    </div>
                    
                    <div class="form-group">
                        <label>Caracter√≠sticas (opcional)</label>
                        <div class="characteristics-grid">
                            <label class="characteristic-checkbox">
                                <input type="checkbox" name="aviso-caracteristicas" value="estacionamiento">
                                <span>Estacionamiento</span>
                            </label>
                            <label class="characteristic-checkbox">
                                <input type="checkbox" name="aviso-caracteristicas" value="bodega">
                                <span>Bodega</span>
                            </label>
                            <label class="characteristic-checkbox">
                                <input type="checkbox" name="aviso-caracteristicas" value="terraza">
                                <span>Terraza</span>
                            </label>
                            <label class="characteristic-checkbox">
                                <input type="checkbox" name="aviso-caracteristicas" value="piscina">
                                <span>Piscina</span>
                            </label>
                            <label class="characteristic-checkbox">
                                <input type="checkbox" name="aviso-caracteristicas" value="quincho">
                                <span>Quincho</span>
                            </label>
                            <label class="characteristic-checkbox">
                                <input type="checkbox" name="aviso-caracteristicas" value="areas_verdes">
                                <span>√Åreas Verdes</span>
                            </label>
                            <label class="characteristic-checkbox">
                                <input type="checkbox" name="aviso-caracteristicas" value="gimnasio">
                                <span>Gimnasio</span>
                            </label>
                            <label class="characteristic-checkbox">
                                <input type="checkbox" name="aviso-caracteristicas" value="seguridad">
                                <span>Seguridad 24/7</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- CAMPOS GENERALES (para otros tipos) -->
                <div id="campos-generales">
                    <div class="form-group">
                        <label for="aviso-descripcion">Descripci√≥n detallada *</label>
                        <textarea id="aviso-descripcion" class="form-control form-textarea" placeholder="Describe exactamente lo que buscas, caracter√≠sticas importantes, preferencias, etc." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-presupuesto">Presupuesto m√°ximo (USD) *</label>
                        <input type="number" id="aviso-presupuesto" class="form-control" min="0" step="100" placeholder="Ej: 50000" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-zona">Zona o ubicaci√≥n *</label>
                        <input type="text" id="aviso-zona" class="form-control" placeholder="Ej: Centro ciudad, Zona norte, Online, etc.">
                    </div>
                    
                    <div class="form-group">
                        <label for="aviso-urgencia">Nivel de urgencia *</label>
                        <select id="aviso-urgencia" class="form-control" required>
                            <option value="baja">Baja (1-3 meses)</option>
                            <option value="media" selected>Media (2-4 semanas)</option>
                            <option value="alta">Alta (1 semana)</option>
                            <option value="inmediata">Inmediata (1-3 d√≠as)</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('create-aviso-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Publicar Aviso</button>
                </div>
            </form>
        </div>
    </div>

    <div id="enviar-propuesta-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="propuesta-modal-title">Enviar Propuesta</h2>
                <button class="modal-close" onclick="closeModal('enviar-propuesta-modal')">√ó</button>
            </div>
            <form id="enviar-propuesta-form" onsubmit="enviarPropuesta(event)">
                <input type="hidden" id="propuesta-aviso-id">
                
                <div class="form-group">
                    <label for="propuesta-precio">Precio ofrecido (USD) *</label>
                    <input type="number" id="propuesta-precio" class="form-control" min="0" step="100" required>
                    <div style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;" id="propuesta-presupuesto-info"></div>
                </div>
                
                <div class="form-group">
                    <label for="propuesta-mensaje">Mensaje personalizado *</label>
                    <textarea id="propuesta-mensaje" class="form-control form-textarea" placeholder="Explica por qu√© tu propuesta es la mejor opci√≥n, incluye detalles importantes, condiciones, etc." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="propuesta-detalles">Detalles adicionales (opcional)</label>
                    <textarea id="propuesta-detalles" class="form-control form-textarea" placeholder="Informaci√≥n adicional, condiciones especiales, garant√≠as, etc."></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('enviar-propuesta-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Enviar Propuesta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editar-aviso-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Editar Aviso</h2>
                <button class="modal-close" onclick="closeModal('editar-aviso-modal')">√ó</button>
            </div>
            <form id="editar-aviso-form" onsubmit="guardarEdicionAviso(event)">
                <input type="hidden" id="editar-aviso-id">
                
                <div class="form-group">
                    <label for="editar-aviso-titulo">T√≠tulo del aviso *</label>
                    <input type="text" id="editar-aviso-titulo" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="editar-aviso-descripcion">Descripci√≥n detallada *</label>
                    <textarea id="editar-aviso-descripcion" class="form-control form-textarea" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editar-aviso-presupuesto">Presupuesto m√°ximo (USD) *</label>
                    <input type="number" id="editar-aviso-presupuesto" class="form-control" min="0" step="100" required>
                </div>
                
                <div class="form-group">
                    <label for="editar-aviso-zona">Zona o ubicaci√≥n *</label>
                    <input type="text" id="editar-aviso-zona" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="editar-aviso-urgencia">Nivel de urgencia *</label>
                    <select id="editar-aviso-urgencia" class="form-control" required>
                        <option value="baja">Baja</option>
                        <option value="media">Media</option>
                        <option value="alta">Alta</option>
                        <option value="inmediata">Inmediata</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editar-aviso-estado">Estado *</label>
                    <select id="editar-aviso-estado" class="form-control" required>
                        <option value="abierto">Abierto</option>
                        <option value="negociando">Negociando</option>
                        <option value="cerrado">Cerrado</option>
                        <option value="rechazado">Rechazado</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editar-aviso-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notifications-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Notificaciones</h2>
                <button class="modal-close" onclick="closeModal('notifications-modal')">√ó</button>
            </div>
            <div id="notifications-list">
                <!-- Se llena din√°micamente -->
            </div>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // ============================================
        // VARIABLES GLOBALES Y ESTADO
        // ============================================
        let currentUser = null;
        let deferredPrompt = null;
        const APP_KEY = 'marketplace_inverso_pro_data';
        let currentAvisoId = null;
        let currentPropuestaId = null;
        let notifications = [];
        let unreadMessages = 0;

        // ============================================
        // DATOS GEOGR√ÅFICOS DE CHILE
        // ============================================
        const chileData = {
            regiones: [
                { id: 1, nombre: 'Arica y Parinacota' },
                { id: 2, nombre: 'Tarapac√°' },
                { id: 3, nombre: 'Antofagasta' },
                { id: 4, nombre: 'Atacama' },
                { id: 5, nombre: 'Coquimbo' },
                { id: 6, nombre: 'Valpara√≠so' },
                { id: 7, nombre: 'Metropolitana de Santiago' },
                { id: 8, nombre: 'O\'Higgins' },
                { id: 9, nombre: 'Maule' },
                { id: 10, nombre: '√ëuble' },
                { id: 11, nombre: 'Biob√≠o' },
                { id: 12, nombre: 'La Araucan√≠a' },
                { id: 13, nombre: 'Los R√≠os' },
                { id: 14, nombre: 'Los Lagos' },
                { id: 15, nombre: 'Ays√©n' },
                { id: 16, nombre: 'Magallanes' }
            ],
            comunas: {
                1: ['Arica', 'Camarones', 'Putre', 'General Lagos'],
                2: ['Iquique', 'Alto Hospicio', 'Pozo Almonte', 'Cami√±a', 'Colchane', 'Huara', 'Pica'],
                3: ['Antofagasta', 'Mejillones', 'Sierra Gorda', 'Taltal', 'Calama', 'Ollag√ºe', 'San Pedro de Atacama', 'Tocopilla', 'Mar√≠a Elena'],
                4: ['Copiap√≥', 'Caldera', 'Tierra Amarilla', 'Cha√±aral', 'Diego de Almagro', 'Vallenar', 'Alto del Carmen', 'Freirina', 'Huasco'],
                5: ['La Serena', 'Coquimbo', 'Andacollo', 'La Higuera', 'Paiguano', 'Vicu√±a', 'Illapel', 'Canela', 'Los Vilos', 'Salamanca', 'Ovalle', 'Combarbal√°', 'Monte Patria', 'Punitaqui', 'R√≠o Hurtado'],
                6: ['Valpara√≠so', 'Casablanca', 'Conc√≥n', 'Juan Fern√°ndez', 'Puchuncav√≠', 'Quintero', 'Vi√±a del Mar', 'Isla de Pascua', 'Los Andes', 'Calle Larga', 'Rinconada', 'San Esteban', 'La Ligua', 'Cabildo', 'Papudo', 'Petorca', 'Zapallar', 'Quillota', 'Calera', 'Hijuelas', 'La Cruz', 'Nogales', 'San Antonio', 'Algarrobo', 'Cartagena', 'El Quisco', 'El Tabo', 'Santo Domingo', 'San Felipe', 'Catemu', 'Llaillay', 'Panquehue', 'Putaendo', 'Santa Mar√≠a', 'Quilpu√©', 'Limache', 'Olmu√©', 'Villa Alemana'],
                7: ['Santiago', 'Cerrillos', 'Cerro Navia', 'Conchal√≠', 'El Bosque', 'Estaci√≥n Central', 'Huechuraba', 'Independencia', 'La Cisterna', 'La Florida', 'La Granja', 'La Pintana', 'La Reina', 'Las Condes', 'Lo Barnechea', 'Lo Espejo', 'Lo Prado', 'Macul', 'Maip√∫', '√ëu√±oa', 'Pedro Aguirre Cerda', 'Pe√±alol√©n', 'Providencia', 'Pudahuel', 'Quilicura', 'Quinta Normal', 'Recoleta', 'Renca', 'San Joaqu√≠n', 'San Miguel', 'San Ram√≥n', 'Vitacura', 'Puente Alto', 'Pirque', 'San Jos√© de Maipo', 'Colina', 'Lampa', 'Tiltil', 'San Bernardo', 'Buin', 'Calera de Tango', 'Paine', 'Melipilla', 'Alhu√©', 'Curacav√≠', 'Mar√≠a Pinto', 'San Pedro', 'Talagante', 'El Monte', 'Isla de Maipo', 'Padre Hurtado', 'Pe√±aflor'],
                8: ['Rancagua', 'Codegua', 'Coinco', 'Coltauco', 'Do√±ihue', 'Graneros', 'Las Cabras', 'Machal√≠', 'Malloa', 'Mostazal', 'Olivar', 'Peumo', 'Pichidegua', 'Quinta de Tilcoco', 'Rengo', 'Requ√≠noa', 'San Vicente', 'Pichilemu', 'La Estrella', 'Litueche', 'Marchihue', 'Navidad', 'San Fernando', 'Ch√©pica', 'Chimbarongo', 'Lolol', 'Nancagua', 'Palmilla', 'Peralillo', 'Placilla', 'Pumanque', 'Santa Cruz'],
                9: ['Talca', 'Constituci√≥n', 'Curepto', 'Empedrado', 'Maule', 'Pelarco', 'Pencahue', 'R√≠o Claro', 'San Clemente', 'San Rafael', 'Cauquenes', 'Chanco', 'Pelluhue', 'Curic√≥', 'Huala√±√©', 'Licant√©n', 'Molina', 'Rauco', 'Romeral', 'Sagrada Familia', 'Teno', 'Vichuqu√©n', 'Linares', 'Colb√∫n', 'Longav√≠', 'Parral', 'Retiro', 'San Javier', 'Villa Alegre', 'Yerbas Buenas'],
                10: ['Chill√°n', 'Bulnes', 'Chill√°n Viejo', 'El Carmen', 'Pemuco', 'Pinto', 'Quill√≥n', 'San Ignacio', 'Yungay', 'Quirihue', 'Cobquecura', 'Coelemu', 'Ninhue', 'Portezuelo', 'R√°nquil', 'Treguaco', 'San Carlos', 'Coihueco', '√ëiqu√©n', 'San Fabi√°n', 'San Nicol√°s'],
                11: ['Concepci√≥n', 'Coronel', 'Chiguayante', 'Florida', 'Hualqui', 'Lota', 'Penco', 'San Pedro de la Paz', 'Santa Juana', 'Talcahuano', 'Tom√©', 'Hualp√©n', 'Lebu', 'Arauco', 'Ca√±ete', 'Contulmo', 'Curanilahue', 'Los √Ålamos', 'Tir√∫a', 'Los √Ångeles', 'Antuco', 'Cabrero', 'Laja', 'Mulch√©n', 'Nacimiento', 'Negrete', 'Quilaco', 'Quilleco', 'San Rosendo', 'Santa B√°rbara', 'Tucapel', 'Yumbel', 'Alto Biob√≠o'],
                12: ['Temuco', 'Carahue', 'Cunco', 'Curarrehue', 'Freire', 'Galvarino', 'Gorbea', 'Lautaro', 'Loncoche', 'Melipeuco', 'Nueva Imperial', 'Padre Las Casas', 'Perquenco', 'Pitrufqu√©n', 'Puc√≥n', 'Saavedra', 'Teodoro Schmidt', 'Tolt√©n', 'Vilc√∫n', 'Villarrica', 'Cholchol', 'Angol', 'Collipulli', 'Curacaut√≠n', 'Ercilla', 'Lonquimay', 'Los Sauces', 'Lumaco', 'Pur√©n', 'Renaico', 'Traigu√©n', 'Victoria'],
                13: ['Valdivia', 'Corral', 'Lanco', 'Los Lagos', 'M√°fil', 'Mariquina', 'Paillaco', 'Panguipulli', 'La Uni√≥n', 'Futrono', 'Lago Ranco', 'R√≠o Bueno'],
                14: ['Puerto Montt', 'Calbuco', 'Cocham√≥', 'Fresia', 'Frutillar', 'Los Muermos', 'Llanquihue', 'Maull√≠n', 'Puerto Varas', 'Castro', 'Ancud', 'Chonchi', 'Curaco de V√©lez', 'Dalcahue', 'Puqueld√≥n', 'Queil√©n', 'Quell√≥n', 'Quemchi', 'Quinchao', 'Osorno', 'Puerto Octay', 'Purranque', 'Puyehue', 'R√≠o Negro', 'San Juan de la Costa', 'San Pablo', 'Chait√©n', 'Futaleuf√∫', 'Hualaihu√©', 'Palena'],
                15: ['Coihaique', 'Lago Verde', 'Ays√©n', 'Cisnes', 'Guaitecas', 'Cochrane', 'O\'Higgins', 'Tortel', 'Chile Chico', 'R√≠o Ib√°√±ez'],
                16: ['Punta Arenas', 'Laguna Blanca', 'R√≠o Verde', 'San Gregorio', 'Cabo de Hornos', 'Ant√°rtica', 'Porvenir', 'Primavera', 'Timaukel', 'Natales', 'Torres del Paine']
            ],
            barrios: {
                'Santiago': ['Centro Hist√≥rico', 'Barrio Brasil', 'Barrio Lastarria', 'Barrio Yungay', 'Barrio Rep√∫blica', 'Barrio Concha y Toro'],
                'Providencia': ['Barrio Italia', 'Barrio Bellavista', 'Barrio Suecia', 'Barrio Parque Bustamante', 'Barrio El Aguilucho'],
                'Las Condes': ['Barrio El Golf', 'Barrio San Dami√°n', 'Barrio Los Dominicos', 'Barrio La Pir√°mide', 'Barrio Manquehue'],
                '√ëu√±oa': ['Barrio Plaza √ëu√±oa', 'Barrio Italia', 'Barrio Irarr√°zaval', 'Barrio Villa Frei'],
                'Vitacura': ['Barrio Alonso de C√≥rdova', 'Barrio Sanhattan', 'Barrio El Golf', 'Barrio Santa Mar√≠a'],
                'Valpara√≠so': ['Cerro Alegre', 'Cerro Concepci√≥n', 'Playa Ancha', 'Cerro Florida', 'Cerro Bar√≥n'],
                'Vi√±a del Mar': ['Re√±aca', 'Miramar', 'Agua Santa', 'Forestal', 'Miraflores'],
                'Concepci√≥n': ['Centro', 'Barrio Universitario', 'Barrio Estaci√≥n', 'Barrio Collao', 'Barrio Laguna Redonda']
            }
        };

        // ============================================
        // FUNCIONES GEOGR√ÅFICAS
        // ============================================
        function cargarRegiones(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">Selecciona una regi√≥n</option>';
            chileData.regiones.forEach(region => {
                const option = document.createElement('option');
                option.value = region.nombre;
                option.textContent = region.nombre;
                select.appendChild(option);
            });
        }

        function cargarComunas() {
            const regionSelect = document.getElementById('aviso-region');
            const comunaSelect = document.getElementById('aviso-comuna');
            
            if (!regionSelect || !comunaSelect) return;
            
            const regionNombre = regionSelect.value;
            const region = chileData.regiones.find(r => r.nombre === regionNombre);
            
            comunaSelect.innerHTML = '<option value="">Selecciona una comuna</option>';
            
            if (!region) return;
            
            const comunas = chileData.comunas[region.id] || [];
            comunas.forEach(comuna => {
                const option = document.createElement('option');
                option.value = comuna;
                option.textContent = comuna;
                comunaSelect.appendChild(option);
            });
        }

        function cargarComunasFiltro() {
            const regionSelect = document.getElementById('filter-inmueble-region');
            const comunaSelect = document.getElementById('filter-inmueble-comuna');
            
            if (!regionSelect || !comunaSelect) return;
            
            const regionNombre = regionSelect.value;
            const region = chileData.regiones.find(r => r.nombre === regionNombre);
            
            comunaSelect.innerHTML = '<option value="">Todas las comunas</option>';
            
            if (!region) return;
            
            const comunas = chileData.comunas[region.id] || [];
            comunas.forEach(comuna => {
                const option = document.createElement('option');
                option.value = comuna;
                option.textContent = comuna;
                comunaSelect.appendChild(option);
            });
        }

        function cargarBarrios() {
            const comunaSelect = document.getElementById('aviso-comuna');
            const barrioSelect = document.getElementById('aviso-barrio');
            
            if (!comunaSelect || !barrioSelect) return;
            
            const comunaNombre = comunaSelect.value;
            const barrios = chileData.barrios[comunaNombre] || [];
            
            barrioSelect.innerHTML = '<option value="">Selecciona un barrio</option>';
            
            barrios.forEach(barrio => {
                const option = document.createElement('option');
                option.value = barrio;
                option.textContent = barrio;
                barrioSelect.appendChild(option);
            });
        }

        // ============================================
        // FUNCIONES DE FORMULARIO DIN√ÅMICO
        // ============================================
        function toggleCamposEspecificos() {
            const tipo = document.getElementById('aviso-tipo').value;
            const camposInmueble = document.getElementById('campos-inmueble');
            const zonaInput = document.getElementById('aviso-zona');
            
            // Ocultar todos los campos espec√≠ficos primero
            camposInmueble.classList.add('hidden');
            
            // Mostrar campos seg√∫n el tipo
            if (tipo === 'inmueble') {
                camposInmueble.classList.remove('hidden');
                
                // Cambiar placeholder del input zona para inmuebles
                if (zonaInput) {
                    zonaInput.placeholder = "Se completar√° autom√°ticamente con regi√≥n y comuna";
                }
                
                // Cargar regiones si no est√°n cargadas
                if (document.getElementById('aviso-region').options.length <= 1) {
                    cargarRegiones('aviso-region');
                }
            } else {
                // Para otros tipos, mostrar placeholder general
                if (zonaInput) {
                    zonaInput.placeholder = "Ej: Centro ciudad, Zona norte, Online, etc.";
                }
            }
        }

        function toggleFiltrosEspecificos() {
            const tipo = document.getElementById('filter-tipo').value;
            const filtrosInmueble = document.getElementById('inmueble-filters');
            
            if (tipo === 'inmueble') {
                filtrosInmueble.classList.remove('hidden');
                
                // Cargar regiones en el filtro si no est√°n cargadas
                if (document.getElementById('filter-inmueble-region').options.length <= 1) {
                    cargarRegiones('filter-inmueble-region');
                }
            } else {
                filtrosInmueble.classList.add('hidden');
            }
        }

        // ============================================
        // DATOS INICIALES DE EJEMPLO (MEJORADOS)
        // ============================================
        const initialData = {
            users: [
                { 
                    id: 1, 
                    email: "comprador@demo.com", 
                    password: "123456", 
                    name: "Juan Comprador",
                    role: "comprador", 
                    createdAt: new Date().toISOString(),
                    avatarColor: "#4361ee",
                    rating: 4.8,
                    totalAvisos: 3,
                    totalPropuestas: 0
                },
                { 
                    id: 2, 
                    email: "vendedor@demo.com", 
                    password: "123456", 
                    name: "Mar√≠a Vendedora",
                    role: "vendedor", 
                    createdAt: new Date().toISOString(),
                    avatarColor: "#7209b7",
                    rating: 4.9,
                    totalAvisos: 0,
                    totalPropuestas: 5
                },
                { 
                    id: 3, 
                    email: "admin@demo.com", 
                    password: "admin123", 
                    name: "Admin Sistema",
                    role: "admin", 
                    createdAt: new Date().toISOString(),
                    avatarColor: "#f72585",
                    rating: 5.0,
                    totalAvisos: 0,
                    totalPropuestas: 0
                },
                { 
                    id: 4, 
                    email: "vendedor2@demo.com", 
                    password: "123456", 
                    name: "Carlos Proveedor",
                    role: "vendedor", 
                    createdAt: new Date(Date.now() - 86400000).toISOString(),
                    avatarColor: "#4cc9f0",
                    rating: 4.5,
                    totalAvisos: 0,
                    totalPropuestas: 8
                }
            ],
            avisos: [
                { 
                    id: 1, 
                    userId: 1, 
                    tipo: "auto", 
                    titulo: "Busco SUV familiar 2020-2022 con buen estado", 
                    descripcion: "Necesito un SUV familiar con espacio para 5 personas, preferiblemente marca Toyota o Honda. Debe estar en buen estado, m√°ximo 40,000 km. Busco buen precio y garant√≠a.\n\nRequisitos:\n- M√°ximo 40,000 km\n- Buen estado mec√°nico\n- Preferiblemente blanco o negro\n- Documentaci√≥n en regla\n- Servicio completo de mantenimiento",
                    presupuesto: 35000, 
                    zona: "Ciudad Capital y alrededores", 
                    urgencia: "media", 
                    estado: "abierto",
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    propuestas: [1, 2],
                    vistas: 15,
                    destacado: true
                },
                { 
                    id: 2, 
                    userId: 1, 
                    tipo: "inmueble", 
                    titulo: "Departamento 3 habitaciones cerca de universidad", 
                    descripcion: "Busco apartamento para familia de 4, m√≠nimo 3 habitaciones, 2 ba√±os. Preferiblemente en edificio con √°reas verdes y seguridad 24/7.\n\nCaracter√≠sticas deseadas:\n- M√≠nimo 90m¬≤\n- Cocina integral\n- Parqueadero incluido\n- Aire acondicionado\n- Cerca de transporte p√∫blico\n- Acepto condominio",
                    presupuesto: 250000, 
                    zona: "Regi√≥n Metropolitana, Santiago", 
                    urgencia: "baja", 
                    estado: "negociando",
                    createdAt: new Date(Date.now() - 86400000).toISOString(),
                    updatedAt: new Date().toISOString(),
                    propuestas: [3],
                    vistas: 28,
                    destacado: false,
                    // Campos espec√≠ficos para inmuebles
                    operacion: "venta",
                    tipoInmueble: "departamento",
                    region: "Metropolitana de Santiago",
                    comuna: "Santiago",
                    barrio: "Centro Hist√≥rico",
                    dormitorios: 3,
                    banos: 2,
                    superficieUtil: 95,
                    superficieTotal: 110,
                    caracteristicas: ["estacionamiento", "areas_verdes", "seguridad"]
                },
                { 
                    id: 3, 
                    userId: 1, 
                    tipo: "inmueble", 
                    titulo: "Casa con terreno amplio en sector residencial", 
                    descripcion: "Busco casa con terreno amplio m√≠nimo 300m¬≤, 4 dormitorios, 3 ba√±os, para familia numerosa. Preferiblemente con piscina y quincho.\n\nRequisitos:\n- Sector residencial tranquilo\n- Buen acceso a servicios\n- Preferiblemente con jard√≠n\n- Cocina amplia\n- Garage para 2 veh√≠culos",
                    presupuesto: 450000, 
                    zona: "Regi√≥n Metropolitana, Las Condes", 
                    urgencia: "media", 
                    estado: "abierto",
                    createdAt: new Date(Date.now() - 172800000).toISOString(),
                    updatedAt: new Date(Date.now() - 86400000).toISOString(),
                    propuestas: [],
                    vistas: 42,
                    destacado: true,
                    // Campos espec√≠ficos para inmuebles
                    operacion: "venta",
                    tipoInmueble: "casa",
                    region: "Metropolitana de Santiago",
                    comuna: "Las Condes",
                    barrio: "Barrio El Golf",
                    dormitorios: 4,
                    banos: 3,
                    superficieUtil: 180,
                    superficieTotal: 350,
                    caracteristicas: ["estacionamiento", "piscina", "quincho", "areas_verdes", "seguridad"]
                },
                { 
                    id: 4, 
                    userId: 1, 
                    tipo: "tecnologia", 
                    titulo: "Laptop gamer con RTX 3070 y buen rendimiento", 
                    descripcion: "Busco laptop para gaming y trabajo, m√≠nimo RTX 3070, 16GB RAM, pantalla 144Hz. Marca preferida: ASUS ROG o Lenovo Legion.\n\nEspecificaciones:\n- Procesador i7 o Ryzen 7\n- 16GB RAM (expandible)\n- SSD 1TB\n- Pantalla 15-17 pulgadas\n- Garant√≠a vigente\n- Sin da√±os f√≠sicos",
                    presupuesto: 1800, 
                    zona: "Env√≠o nacional", 
                    urgencia: "alta", 
                    estado: "abierto",
                    createdAt: new Date(Date.now() - 259200000).toISOString(),
                    updatedAt: new Date(Date.now() - 172800000).toISOString(),
                    propuestas: [],
                    vistas: 42,
                    destacado: true
                },
                { 
                    id: 5, 
                    userId: 2, 
                    tipo: "inmueble", 
                    titulo: "Oficina en zona c√©ntrica para equipo de 10 personas", 
                    descripcion: "Necesito oficina para equipo de trabajo, m√≠nimo 5 oficinas individuales, sala de reuniones, recepci√≥n. Preferiblemente en edificio corporativo con buena conectividad.\n\nRequisitos:\n- M√≠nimo 120m¬≤\n- Aire acondicionado central\n- Conexi√≥n de fibra √≥ptica\n- Estacionamientos para visitas\n- Cerca de metro/transporte",
                    presupuesto: 3000, 
                    zona: "Regi√≥n Metropolitana, Providencia", 
                    urgencia: "inmediata", 
                    estado: "abierto",
                    createdAt: new Date(Date.now() - 43200000).toISOString(),
                    updatedAt: new Date(Date.now() - 43200000).toISOString(),
                    propuestas: [],
                    vistas: 18,
                    destacado: false,
                    // Campos espec√≠ficos para inmuebles
                    operacion: "arriendo",
                    tipoInmueble: "oficina",
                    region: "Metropolitana de Santiago",
                    comuna: "Providencia",
                    barrio: "Barrio Italia",
                    dormitorios: 5,
                    banos: 2,
                    superficieUtil: 125,
                    superficieTotal: 125,
                    caracteristicas: ["estacionamiento", "gimnasio", "seguridad"]
                }
            ],
            propuestas: [
                { 
                    id: 1, 
                    avisoId: 1, 
                    vendedorId: 2, 
                    precio: 32000, 
                    mensaje: "Toyota RAV4 2021, 35,000 km, excelente estado. √önico due√±o, mantenimientos al d√≠a en agencia. Incluye garant√≠a extendida de 2 a√±os. Disponible para prueba de manejo.",
                    detalles: "Color blanco perla, techo panor√°mico, sistema de sonido premium, c√°maras 360¬∞, sensores de estacionamiento. Historial completo disponible.",
                    estado: "pendiente",
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    destacada: true
                },
                { 
                    id: 2, 
                    avisoId: 1, 
                    vendedorId: 4, 
                    precio: 31500, 
                    mensaje: "Honda CR-V 2020, 38,000 km, impecable. Full equipo: piel, navegaci√≥n, asientos calefactados. Reci√©n pas√≥ revisi√≥n t√©cnica.",
                    detalles: "Color gris metalizado, rines de aleaci√≥n 18\", control crucero adaptativo, alerta de cambio de carril. Todos los servicios en Honda.",
                    estado: "pendiente",
                    createdAt: new Date(Date.now() - 3600000).toISOString(),
                    updatedAt: new Date(Date.now() - 3600000).toISOString(),
                    destacada: false
                },
                { 
                    id: 3, 
                    avisoId: 2, 
                    vendedorId: 2, 
                    precio: 240000, 
                    mensaje: "Tengo exactamente lo que buscas. Apartamento en condominio 'Los Pinos', 120m2, 3 hab, 2 ba√±os, cocina integral, parqueadero techado. Podemos negociar el precio.",
                    detalles: "Condominio con piscina, gimnasio, √°reas verdes, seguridad 24/7. Apartamento en 3er piso, vista a jardines. Listo para entrega inmediata.",
                    estado: "aceptada",
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    destacada: true
                }
            ],
            chats: [
                {
                    id: 1,
                    avisoId: 2,
                    propuestaId: 3,
                    participantes: [1, 2],
                    mensajes: [
                        { 
                            id: 1, 
                            userId: 2, 
                            text: "Hola Juan, vi tu aviso y tengo una propuesta que podr√≠a interesarte. Apartamento en condominio seguro, 120m2, 3 habitaciones, 2 ba√±os.", 
                            timestamp: new Date(Date.now() - 3600000).toISOString(),
                            leido: true
                        },
                        { 
                            id: 2, 
                            userId: 1, 
                            text: "Hola Mar√≠a, s√≠ me interesa. ¬øPodr√≠as darme m√°s detalles sobre la ubicaci√≥n exacta y los servicios del condominio?", 
                            timestamp: new Date(Date.now() - 1800000).toISOString(),
                            leido: true
                        },
                        { 
                            id: 3, 
                            userId: 2, 
                            text: "Claro, est√° en el condominio 'Los Pinos' en la Av. Principal. Tiene piscina, gimnasio, parque infantil, seguridad 24/7 con c√°maras. La zona es muy tranquila y cerca de la universidad.", 
                            timestamp: new Date(Date.now() - 900000).toISOString(),
                            leido: true
                        },
                        { 
                            id: 4, 
                            userId: 1, 
                            text: "Suena bien. ¬øEl precio de 240,000 es negociable? ¬øIncluye parqueadero?", 
                            timestamp: new Date(Date.now() - 300000).toISOString(),
                            leido: false
                        }
                    ],
                    unreadCount: 1,
                    lastMessage: "Suena bien. ¬øEl precio de 240,000 es negociable? ¬øIncluye parqueadero?",
                    lastMessageTime: new Date(Date.now() - 300000).toISOString(),
                    activo: true
                },
                {
                    id: 2,
                    avisoId: 1,
                    propuestaId: 1,
                    participantes: [1, 2],
                    mensajes: [
                        { 
                            id: 1, 
                            userId: 2, 
                            text: "Hola, te envi√© una propuesta para el SUV. El Toyota RAV4 est√° en excelente estado. ¬øTe gustar√≠a agendar una prueba de manejo?", 
                            timestamp: new Date(Date.now() - 7200000).toISOString(),
                            leido: true
                        }
                    ],
                    unreadCount: 0,
                    lastMessage: "Hola, te envi√© una propuesta para el SUV. El Toyota RAV4 est√° en excelente estado. ¬øTe gustar√≠a agendar una prueba de manejo?",
                    lastMessageTime: new Date(Date.now() - 7200000).toISOString(),
                    activo: true
                }
            ],
            notifications: [
                {
                    id: 1,
                    userId: 1,
                    type: "propuesta_nueva",
                    title: "Nueva propuesta recibida",
                    message: "Mar√≠a Vendedora envi√≥ una propuesta a tu aviso 'Departamento 3 habitaciones'",
                    data: { avisoId: 2, propuestaId: 3 },
                    read: false,
                    createdAt: new Date(Date.now() - 3600000).toISOString()
                },
                {
                    id: 2,
                    userId: 2,
                    type: "propuesta_aceptada",
                    title: "¬°Propuesta aceptada!",
                    message: "Juan Comprador acept√≥ tu propuesta para el apartamento",
                    data: { avisoId: 2, propuestaId: 3 },
                    read: true,
                    createdAt: new Date(Date.now() - 1800000).toISOString()
                },
                {
                    id: 3,
                    userId: 1,
                    type: "mensaje_nuevo",
                    title: "Nuevo mensaje",
                    message: "Mar√≠a Vendedora respondi√≥ en el chat del apartamento",
                    data: { chatId: 1 },
                    read: false,
                    createdAt: new Date(Date.now() - 900000).toISOString()
                }
            ],
            nextIds: {
                users: 5,
                avisos: 6,
                propuestas: 4,
                chats: 3,
                notifications: 4
            }
        };

        // ============================================
        // FUNCIONES DE PERSISTENCIA
        // ============================================
        function loadData() {
            const data = localStorage.getItem(APP_KEY);
            if (!data) {
                saveData(initialData);
                return initialData;
            }
            return JSON.parse(data);
        }

        function saveData(data) {
            localStorage.setItem(APP_KEY, JSON.stringify(data));
        }

        function getData() {
            return loadData();
        }

        function updateData(updates) {
            const data = getData();
            Object.assign(data, updates);
            saveData(data);
            return data;
        }

        // ============================================
        // FUNCIONES DE AUTENTICACI√ìN
        // ============================================
        function login(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const data = getData();
            
            const user = data.users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showUserUI();
                showView('dashboard');
                updateDashboard();
                updateNotifications();
                showToast(`¬°Bienvenido ${user.name || user.email}!`, 'success');
            } else {
                showToast('Email o contrase√±a incorrectos', 'error');
            }
        }

        function register(event) {
            event.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const name = document.getElementById('register-name').value;
            const role = document.querySelector('input[name="role"]:checked').value;
            const data = getData();
            
            // Verificar si el usuario ya existe
            if (data.users.find(u => u.email === email)) {
                showToast('Este email ya est√° registrado', 'error');
                return;
            }
            
            // Colores para avatares
            const avatarColors = ['#4361ee', '#7209b7', '#4cc9f0', '#f72585', '#ef233c', '#7209b7'];
            const randomColor = avatarColors[Math.floor(Math.random() * avatarColors.length)];
            
            const newUser = {
                id: data.nextIds.users++,
                email,
                password,
                name: name || email.split('@')[0],
                role,
                createdAt: new Date().toISOString(),
                avatarColor: randomColor,
                rating: 5.0,
                totalAvisos: 0,
                totalPropuestas: 0
            };
            
            data.users.push(newUser);
            saveData(data);
            
            showToast(`¬°Cuenta creada exitosamente! Bienvenid@ a MarketConnect`, 'success');
            showView('login');
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            hideUserUI();
            showView('landing');
            showToast('Sesi√≥n cerrada correctamente', 'info');
        }

        function checkAuth() {
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                showUserUI();
                showView('dashboard');
                updateDashboard();
                updateNotifications();
            }
        }

        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        function showView(viewId) {
            // Ocultar todas las vistas
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Actualizar navegaci√≥n activa
            document.querySelectorAll('.desktop-nav a').forEach(a => {
                a.classList.remove('active-nav');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mostrar la vista solicitada
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
                
                // Marcar navegaci√≥n activa
                if (viewId === 'dashboard') {
                    document.getElementById('nav-dashboard').classList.add('active-nav');
                } else if (viewId === 'avisos') {
                    document.getElementById('nav-avisos').classList.add('active-nav');
                } else if (viewId === 'propuestas') {
                    document.getElementById('nav-propuestas').classList.add('active-nav');
                } else if (viewId === 'chats') {
                    document.getElementById('nav-chats').classList.add('active-nav');
                } else if (viewId === 'perfil') {
                    document.getElementById('nav-perfil').classList.add('active-nav');
                } else if (viewId === 'admin') {
                    document.getElementById('nav-admin').classList.add('active-nav');
                }
            }
            
            // Actualizar t√≠tulo din√°mico
            if (currentUser) {
                if (viewId === 'dashboard') {
                    document.getElementById('dashboard-title-text').textContent = 
                        `Dashboard ${currentUser.role === 'comprador' ? 'Comprador' : 'Vendedor'}`;
                    updateDashboard();
                }
                
                if (viewId === 'avisos') {
                    document.getElementById('avisos-title').textContent = 
                        currentUser.role === 'comprador' ? 'Mis Avisos' : 'Avisos Disponibles';
                    loadAvisos();
                }
                
                if (viewId === 'propuestas') {
                    document.getElementById('propuestas-title').textContent = 
                        currentUser.role === 'comprador' ? 'Propuestas Recibidas' : 'Mis Propuestas';
                    loadPropuestas();
                }
                
                // Mostrar/ocultar botones seg√∫n rol
                const createBtn1 = document.getElementById('create-aviso-btn');
                const createBtn2 = document.getElementById('create-aviso-btn-2');
                if (createBtn1) createBtn1.classList.toggle('hidden', currentUser?.role !== 'comprador');
                if (createBtn2) createBtn2.classList.toggle('hidden', currentUser?.role !== 'comprador');
            }
            
            // Cargar datos espec√≠ficos de la vista
            switch(viewId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'avisos':
                    loadAvisos();
                    break;
                case 'detalle-aviso':
                    if (currentAvisoId) {
                        loadDetalleAviso(currentAvisoId);
                    }
                    break;
                case 'propuestas':
                    loadPropuestas();
                    break;
                case 'chats':
                    loadChats();
                    break;
                case 'perfil':
                    loadProfile();
                    break;
                case 'admin':
                    if (currentUser?.role === 'admin') {
                        loadAdminPanel();
                    } else {
                        showView('dashboard');
                    }
                    break;
            }
        }

        function showUserUI() {
            // Mostrar elementos para usuario autenticado
            document.getElementById('login-btn').classList.add('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('user-avatar').classList.remove('hidden');
            document.getElementById('user-avatar-container').classList.remove('hidden');
            
            // Actualizar info de usuario
            const displayName = currentUser.name || currentUser.email.split('@')[0];
            const firstLetter = displayName.charAt(0).toUpperCase();
            document.getElementById('user-avatar').textContent = firstLetter;
            document.getElementById('user-avatar').style.background = currentUser.avatarColor;
            
            // Actualizar dropdown
            document.getElementById('dropdown-avatar').textContent = firstLetter;
            document.getElementById('dropdown-avatar').style.background = currentUser.avatarColor;
            document.getElementById('dropdown-email').textContent = currentUser.email;
            document.getElementById('dropdown-role').textContent = 
                currentUser.role === 'comprador' ? 'Comprador' : 
                currentUser.role === 'vendedor' ? 'Vendedor' : 'Administrador';
            document.getElementById('dropdown-role').className = 'badge ' + 
                (currentUser.role === 'comprador' ? 'badge-info' : 
                 currentUser.role === 'vendedor' ? 'badge-success' : 'badge-warning');
            
            // Actualizar badge de rol
            document.getElementById('user-role-badge').textContent = 
                currentUser.role === 'comprador' ? 'Comprador' : 
                currentUser.role === 'vendedor' ? 'Vendedor' : 'Admin';
            document.getElementById('user-role-badge').className = 'badge ' + 
                (currentUser.role === 'comprador' ? 'badge-info' : 
                 currentUser.role === 'vendedor' ? 'badge-success' : 'badge-warning');
            
            // Mostrar navegaci√≥n seg√∫n rol
            document.getElementById('nav-dashboard').classList.remove('hidden');
            document.getElementById('nav-avisos').classList.remove('hidden');
            document.getElementById('nav-propuestas').classList.remove('hidden');
            document.getElementById('nav-chats').classList.remove('hidden');
            document.getElementById('nav-perfil').classList.remove('hidden');
            
            if (currentUser.role === 'admin') {
                document.getElementById('nav-admin').classList.remove('hidden');
            }
            
            // Mostrar men√∫ m√≥vil
            document.querySelector('.mobile-nav').classList.remove('hidden');
            
            // Actualizar notificaciones
            updateNotificationBadges();
        }

        function hideUserUI() {
            // Ocultar elementos de usuario autenticado
            document.getElementById('login-btn').classList.remove('hidden');
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('user-avatar').classList.add('hidden');
            document.getElementById('user-avatar-container').classList.add('hidden');
            document.getElementById('user-dropdown').classList.add('hidden');
            
            // Ocultar navegaci√≥n
            document.querySelectorAll('.desktop-nav a').forEach(a => {
                if (!a.onclick || a.onclick.toString().includes('landing')) return;
                a.classList.add('hidden');
            });
            
            // Ocultar men√∫ m√≥vil
            document.querySelector('.mobile-nav').classList.add('hidden');
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Cerrar al hacer click fuera
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeUserMenuOnClickOutside);
                }, 100);
            }
        }

        function closeUserMenuOnClickOutside(event) {
            const dropdown = document.getElementById('user-dropdown');
            const avatar = document.getElementById('user-avatar');
            
            if (!dropdown.contains(event.target) && !avatar.contains(event.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeUserMenuOnClickOutside);
            }
        }

        function showToast(message, type = 'info') {
            // Crear toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 30px;
                right: 30px;
                padding: 20px 25px;
                background: ${type === 'success' ? '#4cc9f0' : type === 'error' ? '#ef233c' : type === 'warning' ? '#f72585' : '#4361ee'};
                color: white;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-lg);
                z-index: 2000;
                animation: slideInUp 0.3s ease;
                max-width: 350px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            toast.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span><span>${message}</span>`;
            document.body.appendChild(toast);
            
            // Remover despu√©s de 4 segundos
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 4000);
        }

        // ============================================
        // FUNCIONES DE AVISOS (MEJORADAS CON INMUEBLES)
        // ============================================
        function showCreateAvisoModal() {
            if (currentUser?.role !== 'comprador') {
                showToast('Solo los compradores pueden crear avisos', 'warning');
                return;
            }
            
            // Resetear formulario y campos
            document.getElementById('create-aviso-form').reset();
            document.getElementById('campos-inmueble').classList.add('hidden');
            
            // Cargar regiones
            cargarRegiones('aviso-region');
            
            showModal('create-aviso-modal');
        }

        function crearAviso(event) {
            event.preventDefault();
            
            const data = getData();
            const tipo = document.getElementById('aviso-tipo').value;
            
            // Validar tipo
            if (!tipo) {
                showToast('Selecciona un tipo de aviso', 'error');
                return;
            }
            
            // Crear objeto base del aviso
            const nuevoAviso = {
                id: data.nextIds.avisos++,
                userId: currentUser.id,
                tipo: tipo,
                titulo: document.getElementById('aviso-titulo').value,
                descripcion: document.getElementById('aviso-descripcion').value,
                presupuesto: parseInt(document.getElementById('aviso-presupuesto').value),
                zona: document.getElementById('aviso-zona').value,
                urgencia: document.getElementById('aviso-urgencia').value,
                estado: 'abierto',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                propuestas: [],
                vistas: 0,
                destacado: false
            };
            
            // Si es inmueble, agregar campos espec√≠ficos
            if (tipo === 'inmueble') {
                const operacion = document.querySelector('input[name="operacion"]:checked');
                nuevoAviso.operacion = operacion ? operacion.value : 'venta';
                nuevoAviso.tipoInmueble = document.getElementById('aviso-tipo-inmueble').value;
                nuevoAviso.region = document.getElementById('aviso-region').value;
                nuevoAviso.comuna = document.getElementById('aviso-comuna').value;
                nuevoAviso.barrio = document.getElementById('aviso-barrio').value;
                nuevoAviso.dormitorios = parseInt(document.getElementById('aviso-dormitorios').value);
                nuevoAviso.banos = parseInt(document.getElementById('aviso-banos').value);
                nuevoAviso.superficieUtil = parseInt(document.getElementById('aviso-superficie-util').value);
                nuevoAviso.superficieTotal = parseInt(document.getElementById('aviso-superficie-total').value);
                
                // Caracter√≠sticas (checkboxes)
                const caracteristicasCheckboxes = document.querySelectorAll('input[name="aviso-caracteristicas"]:checked');
                nuevoAviso.caracteristicas = Array.from(caracteristicasCheckboxes).map(cb => cb.value);
                
                // Actualizar zona con ubicaci√≥n jer√°rquica
                nuevoAviso.zona = `${nuevoAviso.region}, ${nuevoAviso.comuna}`;
            }
            
            // Validar campos requeridos
            if (!nuevoAviso.titulo || !nuevoAviso.descripcion || !nuevoAviso.presupuesto || !nuevoAviso.zona) {
                showToast('Completa todos los campos obligatorios', 'error');
                return;
            }
            
            data.avisos.push(nuevoAviso);
            
            // Actualizar contador del usuario
            const user = data.users.find(u => u.id === currentUser.id);
            user.totalAvisos = (user.totalAvisos || 0) + 1;
            
            saveData(data);
            
            // Crear notificaci√≥n para vendedores (solo si es inmueble)
            if (tipo === 'inmueble') {
                const vendedores = data.users.filter(u => u.role === 'vendedor');
                vendedores.forEach(vendedor => {
                    data.notifications.push({
                        id: data.nextIds.notifications++,
                        userId: vendedor.id,
                        type: "aviso_nuevo",
                        title: "Nuevo aviso inmobiliario publicado",
                        message: `${user.name || user.email} busca: "${nuevoAviso.titulo}" en ${nuevoAviso.comuna}`,
                        data: { avisoId: nuevoAviso.id },
                        read: false,
                        createdAt: new Date().toISOString()
                    });
                });
                
                saveData(data);
            }
            
            closeModal('create-aviso-modal');
            showToast('¬°Aviso publicado exitosamente! Los vendedores ya pueden verlo.', 'success');
            
            // Resetear formulario
            document.getElementById('create-aviso-form').reset();
            document.getElementById('campos-inmueble').classList.add('hidden');
            
            // Redirigir al detalle del aviso
            currentAvisoId = nuevoAviso.id;
            showView('detalle-aviso');
        }

        function loadAvisos() {
            const data = getData();
            const container = document.getElementById('avisos-list');
            
            if (!container) return;
            
            let avisos = [];
            
            if (currentUser.role === 'comprador') {
                // Mostrar solo los avisos del usuario
                avisos = data.avisos.filter(a => a.userId === currentUser.id);
            } else if (currentUser.role === 'vendedor') {
                // Mostrar avisos activos de otros usuarios
                avisos = data.avisos.filter(a => a.userId !== currentUser.id && a.estado === 'abierto');
            }
            
            // Aplicar filtros generales
            const tipo = document.getElementById('filter-tipo')?.value;
            const presupuesto = document.getElementById('filter-presupuesto')?.value;
            const estado = document.getElementById('filter-estado')?.value;
            const urgencia = document.getElementById('filter-urgencia')?.value;
            
            if (tipo) avisos = avisos.filter(a => a.tipo === tipo);
            if (presupuesto) avisos = avisos.filter(a => a.presupuesto <= parseInt(presupuesto));
            if (estado) avisos = avisos.filter(a => a.estado === estado);
            if (urgencia) avisos = avisos.filter(a => a.urgencia === urgencia);
            
            // Aplicar filtros espec√≠ficos para inmuebles si est√°n activos
            if (tipo === 'inmueble' && document.getElementById('inmueble-filters') && 
                !document.getElementById('inmueble-filters').classList.contains('hidden')) {
                
                const operacion = document.getElementById('filter-inmueble-operacion')?.value;
                const tipoInmueble = document.getElementById('filter-inmueble-tipo')?.value;
                const region = document.getElementById('filter-inmueble-region')?.value;
                const comuna = document.getElementById('filter-inmueble-comuna')?.value;
                const dormitorios = document.getElementById('filter-inmueble-dormitorios')?.value;
                const banos = document.getElementById('filter-inmueble-banos')?.value;
                const supUtilMin = document.getElementById('filter-inmueble-sup-util-min')?.value;
                const supUtilMax = document.getElementById('filter-inmueble-sup-util-max')?.value;
                const supTotalMin = document.getElementById('filter-inmueble-sup-total-min')?.value;
                const supTotalMax = document.getElementById('filter-inmueble-sup-total-max')?.value;
                
                // Filtrar por operaci√≥n
                if (operacion) {
                    avisos = avisos.filter(a => a.operacion === operacion);
                }
                
                // Filtrar por tipo de inmueble
                if (tipoInmueble) {
                    avisos = avisos.filter(a => a.tipoInmueble === tipoInmueble);
                }
                
                // Filtrar por regi√≥n
                if (region) {
                    avisos = avisos.filter(a => a.region === region);
                }
                
                // Filtrar por comuna
                if (comuna) {
                    avisos = avisos.filter(a => a.comuna === comuna);
                }
                
                // Filtrar por dormitorios
                if (dormitorios) {
                    avisos = avisos.filter(a => a.dormitorios === parseInt(dormitorios));
                }
                
                // Filtrar por ba√±os
                if (banos) {
                    avisos = avisos.filter(a => a.banos === parseInt(banos));
                }
                
                // Filtrar por superficie √∫til
                if (supUtilMin) {
                    avisos = avisos.filter(a => a.superficieUtil >= parseInt(supUtilMin));
                }
                if (supUtilMax) {
                    avisos = avisos.filter(a => a.superficieUtil <= parseInt(supUtilMax));
                }
                
                // Filtrar por superficie total
                if (supTotalMin) {
                    avisos = avisos.filter(a => a.superficieTotal >= parseInt(supTotalMin));
                }
                if (supTotalMax) {
                    avisos = avisos.filter(a => a.superficieTotal <= parseInt(supTotalMax));
                }
                
                // Filtrar por caracter√≠sticas (checkboxes)
                const caracteristicasCheckboxes = document.querySelectorAll('#inmueble-filters input[type="checkbox"]:checked');
                if (caracteristicasCheckboxes.length > 0) {
                    const caracteristicasSeleccionadas = Array.from(caracteristicasCheckboxes).map(cb => cb.value);
                    avisos = avisos.filter(a => {
                        if (!a.caracteristicas || a.caracteristicas.length === 0) return false;
                        return caracteristicasSeleccionadas.every(car => a.caracteristicas.includes(car));
                    });
                }
            }
            
            if (avisos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <h3>No hay avisos</h3>
                        <p>${currentUser.role === 'comprador' ? 'Crea tu primer aviso para empezar' : 'No hay avisos disponibles con los filtros actuales'}</p>
                        ${currentUser.role === 'comprador' ? 
                            '<button class="btn btn-primary" onclick="showCreateAvisoModal()">Crear Mi Primer Aviso</button>' : 
                            '<button class="btn btn-outline" onclick="limpiarFiltros()">Limpiar Filtros</button>'
                        }
                    </div>
                `;
                return;
            }
            
            // Ordenar por fecha (m√°s recientes primero)
            avisos.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            container.innerHTML = avisos.map(aviso => {
                const user = data.users.find(u => u.id === aviso.userId);
                const propuestasCount = aviso.propuestas ? aviso.propuestas.length : 0;
                
                // Formatear urgencia
                const urgenciaText = {
                    'baja': 'üü¢ Baja',
                    'media': 'üü° Media',
                    'alta': 'üî¥ Alta',
                    'inmediata': 'üî• Inmediata'
                }[aviso.urgencia] || aviso.urgencia;
                
                // Formatear tipo con icono
                const tipoIcon = {
                    'inmueble': 'üè†',
                    'auto': 'üöó',
                    'motos': 'üèçÔ∏è',
                    'tecnologia': 'üíª',
                    'servicios': 'üîß',
                    'otros': 'üì¶'
                }[aviso.tipo] || 'üìã';
                
                // Informaci√≥n espec√≠fica para inmuebles
                let infoEspecifica = '';
                if (aviso.tipo === 'inmueble') {
                    infoEspecifica = `
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0;">
                            <span class="badge badge-light">${aviso.operacion}</span>
                            <span class="badge badge-light">${aviso.tipoInmueble}</span>
                            ${aviso.dormitorios > 0 ? `<span class="badge badge-light">üõèÔ∏è ${aviso.dormitorios}</span>` : ''}
                            <span class="badge badge-light">üöø ${aviso.banos}</span>
                            <span class="badge badge-light">üìê ${aviso.superficieUtil}m¬≤</span>
                        </div>
                    `;
                }
                
                return `
                    <div class="aviso-card" onclick="verDetalleAviso(${aviso.id})">
                        <div class="aviso-header">
                            <div>
                                <div class="aviso-title">${aviso.titulo}</div>
                                <div class="aviso-status">
                                    <span class="badge ${aviso.estado === 'abierto' ? 'badge-success' : 
                                                      aviso.estado === 'negociando' ? 'badge-warning' : 
                                                      aviso.estado === 'cerrado' ? 'badge-info' : 'badge-danger'}">
                                        ${aviso.estado}
                                    </span>
                                    <span class="badge badge-light">${tipoIcon} ${aviso.tipo}</span>
                                    ${aviso.destacado ? '<span class="badge badge-warning">‚≠ê Destacado</span>' : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.4rem; font-weight: 800; color: var(--primary);">
                                    $${aviso.presupuesto.toLocaleString()}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--gray);">Presupuesto</div>
                            </div>
                        </div>
                        
                        ${infoEspecifica}
                        
                        <div class="aviso-meta">
                            <span><strong>üìç Ubicaci√≥n:</strong> ${aviso.zona}</span>
                            <span><strong>‚è±Ô∏è Urgencia:</strong> ${urgenciaText}</span>
                            <span><strong>üí¨ Propuestas:</strong> ${propuestasCount}</span>
                            ${currentUser.role === 'vendedor' ? `<span><strong>üë§ Publicado por:</strong> ${user.name || user.email}</span>` : ''}
                        </div>
                        
                        <div class="aviso-description">
                            ${aviso.descripcion.substring(0, 120)}...
                        </div>
                        
                        <div class="aviso-actions">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); verDetalleAviso(${aviso.id})">
                                Ver Detalles
                            </button>
                            
                            ${currentUser.role === 'comprador' ? `
                                <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); editarAviso(${aviso.id})">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); eliminarAviso(${aviso.id})">
                                    üóëÔ∏è Eliminar
                                </button>
                            ` : ''}
                            
                            ${currentUser.role === 'vendedor' && aviso.estado === 'abierto' ? `
                                <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); mostrarEnviarPropuesta(${aviso.id})">
                                    üì® Enviar Propuesta
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function verDetalleAviso(id) {
            currentAvisoId = id;
            showView('detalle-aviso');
        }

        function loadDetalleAviso(id) {
            const data = getData();
            const aviso = data.avisos.find(a => a.id === id);
            const user = data.users.find(u => u.id === aviso.userId);
            
            if (!aviso) {
                showToast('El aviso no existe', 'error');
                showView('avisos');
                return;
            }
            
            // Incrementar vistas
            aviso.vistas = (aviso.vistas || 0) + 1;
            saveData(data);
            
            // Obtener propuestas para este aviso
            const propuestas = data.propuestas.filter(p => p.avisoId === aviso.id);
            
            // Obtener chats relacionados
            const chats = data.chats.filter(c => c.avisoId === aviso.id && c.participantes.includes(currentUser.id));
            const chatActivo = chats.find(c => c.activo) || (chats.length > 0 ? chats[0] : null);
            
            const container = document.getElementById('detalle-aviso-content');
            
            // Formatear urgencia
            const urgenciaText = {
                'baja': 'üü¢ Baja',
                'media': 'üü° Media',
                'alta': 'üî¥ Alta',
                'inmediata': 'üî• Inmediata'
            }[aviso.urgencia] || aviso.urgencia;
            
            // Formatear tipo con icono
            const tipoIcon = {
                'inmueble': 'üè†',
                'auto': 'üöó',
                'motos': 'üèçÔ∏è',
                'tecnologia': 'üíª',
                'servicios': 'üîß',
                'otros': 'üì¶'
            }[aviso.tipo] || 'üìã';
            
            // Determinar si el usuario actual es el creador del aviso
            const esCreador = aviso.userId === currentUser.id;
            
            // Informaci√≥n espec√≠fica para inmuebles
            let infoInmueble = '';
            if (aviso.tipo === 'inmueble') {
                const operacionText = {
                    'venta': 'Venta',
                    'arriendo': 'Arriendo',
                    'arriendo_temporal': 'Arriendo Temporal',
                    'proyecto_nuevo': 'Proyecto Nuevo'
                }[aviso.operacion] || aviso.operacion;
                
                infoInmueble = `
                    <div class="detalle-meta-grid">
                        <div class="meta-card">
                            <div class="meta-label">Operaci√≥n</div>
                            <div class="meta-value">${operacionText}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">Tipo de Inmueble</div>
                            <div class="meta-value">${aviso.tipoInmueble}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">Ubicaci√≥n</div>
                            <div class="meta-value">${aviso.region}, ${aviso.comuna}</div>
                        </div>
                        ${aviso.barrio ? `
                        <div class="meta-card">
                            <div class="meta-label">Barrio</div>
                            <div class="meta-value">${aviso.barrio}</div>
                        </div>
                        ` : ''}
                        <div class="meta-card">
                            <div class="meta-label">Dormitorios</div>
                            <div class="meta-value">${aviso.dormitorios === 0 ? 'Studio' : aviso.dormitorios}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">Ba√±os</div>
                            <div class="meta-value">${aviso.banos}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">Superficie √∫til</div>
                            <div class="meta-value">${aviso.superficieUtil} m¬≤</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">Superficie total</div>
                            <div class="meta-value">${aviso.superficieTotal} m¬≤</div>
                        </div>
                        ${aviso.caracteristicas && aviso.caracteristicas.length > 0 ? `
                        <div class="meta-card" style="grid-column: span 2;">
                            <div class="meta-label">Caracter√≠sticas</div>
                            <div class="meta-value">
                                ${aviso.caracteristicas.map(c => {
                                    const icon = {
                                        'estacionamiento': 'üöó',
                                        'bodega': 'üì¶',
                                        'terraza': 'üåø',
                                        'piscina': 'üèä',
                                        'quincho': 'üçñ',
                                        'areas_verdes': 'üå≥',
                                        'gimnasio': 'üí™',
                                        'seguridad': 'üîí'
                                    }[c] || '‚úÖ';
                                    return `<span class="badge badge-light" style="margin-right: 5px;">${icon} ${c}</span>`;
                                }).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="detalle-info">
                    <div class="detalle-content">
                        <div class="detalle-header">
                            <div style="flex: 1;">
                                <h1 class="detalle-title">${aviso.titulo}</h1>
                                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                                    <span class="badge ${aviso.estado === 'abierto' ? 'badge-success' : 
                                                      aviso.estado === 'negociando' ? 'badge-warning' : 
                                                      aviso.estado === 'cerrado' ? 'badge-info' : 'badge-danger'}">
                                        ${aviso.estado.toUpperCase()}
                                    </span>
                                    <span class="badge badge-info">${tipoIcon} ${aviso.tipo}</span>
                                    <span class="badge badge-light">${urgenciaText}</span>
                                    ${aviso.destacado ? '<span class="badge badge-warning">‚≠ê Destacado</span>' : ''}
                                    <span class="badge badge-light">üëÅÔ∏è ${aviso.vistas || 0} vistas</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2rem; font-weight: 800; color: var(--primary);">
                                    $${aviso.presupuesto.toLocaleString()}
                                </div>
                                <div style="font-size: 1rem; color: var(--gray);">Presupuesto m√°ximo</div>
                            </div>
                        </div>
                        
                        ${infoInmueble}
                        
                        <div class="detalle-description">
                            ${aviso.descripcion.replace(/\n/g, '<br>')}
                        </div>
                        
                        <div class="estados-section">
                            <h3 style="margin-bottom: 15px;">Estado del aviso:</h3>
                            <div class="estado-badge-large ${aviso.estado === 'abierto' ? 'badge-success' : 
                                                           aviso.estado === 'negociando' ? 'badge-warning' : 
                                                           aviso.estado === 'cerrado' ? 'badge-info' : 'badge-danger'}">
                                <span class="estado-icon">
                                    ${aviso.estado === 'abierto' ? '‚úÖ' : 
                                     aviso.estado === 'negociando' ? 'ü§ù' : 
                                     aviso.estado === 'cerrado' ? '‚úîÔ∏è' : '‚ùå'}
                                </span>
                                <span>
                                    ${aviso.estado === 'abierto' ? 'ABIERTO - Esperando propuestas' : 
                                     aviso.estado === 'negociando' ? 'EN NEGOCIACI√ìN - Conversando con vendedores' : 
                                     aviso.estado === 'cerrado' ? 'CERRADO - Trato concretado' : 'RECHAZADO - No se concret√≥'}
                                </span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 40px; flex-wrap: wrap;">
                            <button class="btn" onclick="showView('avisos')">
                                ‚Üê Volver a Avisos
                            </button>
                            
                            ${esCreador ? `
                                <button class="btn btn-outline" onclick="editarAviso(${aviso.id})">
                                    ‚úèÔ∏è Editar Aviso
                                </button>
                                ${aviso.estado !== 'cerrado' ? `
                                    <button class="btn btn-primary" onclick="cambiarEstadoAviso(${aviso.id}, '${aviso.estado === 'abierto' ? 'negociando' : 'cerrado'}')">
                                        ${aviso.estado === 'abierto' ? 'ü§ù Comenzar Negociaci√≥n' : '‚úîÔ∏è Cerrar Aviso'}
                                    </button>
                                ` : ''}
                            ` : ''}
                            
                            ${currentUser.role === 'vendedor' && aviso.estado === 'abierto' && !esCreador ? `
                                <button class="btn btn-secondary" onclick="mostrarEnviarPropuesta(${aviso.id})">
                                    üì® Enviar Propuesta
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- SECCI√ìN PROPUESTAS -->
                    <div class="propuestas-section">
                        <h3 style="margin-bottom: 25px; display: flex; align-items: center; gap: 10px;">
                            <span>üì®</span>
                            <span>Propuestas (${propuestas.length})</span>
                        </h3>
                        
                        ${propuestas.length > 0 ? propuestas.map(propuesta => {
                            const vendedor = data.users.find(u => u.id === propuesta.vendedorId);
                            const chat = data.chats.find(c => c.propuestaId === propuesta.id);
                            
                            return `
                                <div class="propuesta-item">
                                    <div class="propuesta-item-header">
                                        <div class="propuesta-item-user">
                                            <div class="propuesta-user-avatar" style="background: ${vendedor.avatarColor}">
                                                ${(vendedor.name || vendedor.email).charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <div style="font-weight: 700; font-size: 1.1rem;">${vendedor.name || vendedor.email}</div>
                                                <div style="font-size: 0.9rem; color: var(--gray);">‚≠ê ${vendedor.rating || 5.0}/5.0</div>
                                            </div>
                                        </div>
                                        <div>
                                            <span class="badge ${propuesta.estado === 'pendiente' ? 'badge-warning' : 
                                                               propuesta.estado === 'aceptada' ? 'badge-success' : 
                                                               propuesta.estado === 'rechazada' ? 'badge-danger' : 'badge-info'}">
                                                ${propuesta.estado}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: right; margin: 15px 0;">
                                        <div style="font-size: 1.8rem; font-weight: 800; color: var(--primary);">
                                            $${propuesta.precio.toLocaleString()}
                                        </div>
                                        <div style="font-size: 0.9rem; color: var(--gray);">
                                            ${propuesta.precio <= aviso.presupuesto ? '‚úÖ Dentro del presupuesto' : '‚ö†Ô∏è Supera el presupuesto'}
                                        </div>
                                    </div>
                                    
                                    <div class="propuesta-item-content">
                                        <div style="font-weight: 600; margin-bottom: 10px;">Propuesta:</div>
                                        <div>${propuesta.mensaje}</div>
                                        ${propuesta.detalles ? `
                                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                                                <div style="font-weight: 600; margin-bottom: 5px;">Detalles adicionales:</div>
                                                <div style="font-size: 0.95rem;">${propuesta.detalles}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="propuesta-item-actions">
                                        ${esCreador && aviso.estado === 'abierto' ? `
                                            <button class="btn btn-sm btn-success" onclick="aceptarPropuesta(${propuesta.id}, ${aviso.id})">
                                                ‚úÖ Aceptar
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="rechazarPropuesta(${propuesta.id}, ${aviso.id})">
                                                ‚ùå Rechazar
                                            </button>
                                        ` : ''}
                                        
                                        ${chat ? `
                                            <button class="btn btn-sm btn-primary" onclick="abrirChat(${chat.id}, ${aviso.id})">
                                                üí¨ ${chat.unreadCount > 0 ? `Chat (${chat.unreadCount})` : 'Abrir Chat'}
                                            </button>
                                        ` : currentUser.id === vendedor.id ? `
                                            <button class="btn btn-sm btn-outline" onclick="iniciarChatConComprador(${aviso.id}, ${propuesta.id})">
                                                üí¨ Iniciar Chat
                                            </button>
                                        ` : esCreador ? `
                                            <button class="btn btn-sm btn-primary" onclick="iniciarChatConVendedor(${aviso.id}, ${propuesta.id})">
                                                üí¨ Chatear con ${vendedor.name || vendedor.email}
                                            </button>
                                        ` : ''}
                                        
                                        ${propuesta.destacada ? '<span class="badge badge-warning" style="margin-left: auto;">‚≠ê Destacada</span>' : ''}
                                    </div>
                                    
                                    <div style="font-size: 0.85rem; color: var(--gray); margin-top: 15px; text-align: right;">
                                        Enviada: ${new Date(propuesta.createdAt).toLocaleString()}
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <div class="empty-state" style="padding: 40px 20px;">
                                <div class="empty-state-icon">üì≠</div>
                                <h3>No hay propuestas a√∫n</h3>
                                <p style="margin: 15px 0 25px 0;">
                                    ${esCreador ? 
                                        'A√∫n no has recibido propuestas. Comparte tu aviso para obtener m√°s visibilidad.' : 
                                        'S√© el primero en enviar una propuesta'
                                    }
                                </p>
                                ${!esCreador && currentUser.role === 'vendedor' ? `
                                    <button class="btn btn-primary" onclick="mostrarEnviarPropuesta(${aviso.id})">
                                        üì® Enviar Primera Propuesta
                                    </button>
                                ` : ''}
                            </div>
                        `}
                    </div>
                </div>
                
                <!-- SIDEBAR CON CHAT -->
                <div class="detalle-sidebar">
                    ${chatActivo ? `
                        <div class="chat-section">
                            <div class="chat-header">
                                <div class="chat-header-info">
                                    ${(() => {
                                        const otroUsuarioId = chatActivo.participantes.find(id => id !== currentUser.id);
                                        const otroUsuario = data.users.find(u => u.id === otroUsuarioId);
                                        return `
                                            <div class="chat-user-avatar" style="background: ${otroUsuario.avatarColor}">
                                                ${(otroUsuario.name || otroUsuario.email).charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <h3 style="margin: 0; font-size: 1.2rem;">${otroUsuario.name || otroUsuario.email}</h3>
                                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                                                    ${currentUser.role === 'comprador' ? 'Vendedor' : 'Comprador'}
                                                </p>
                                            </div>
                                        `;
                                    })()}
                                </div>
                            </div>
                            
                            <div class="chat-messages" id="chat-messages-detalle-${chatActivo.id}">
                                ${chatActivo.mensajes.map(mensaje => {
                                    const esMio = mensaje.userId === currentUser.id;
                                    const usuario = data.users.find(u => u.id === mensaje.userId);
                                    return `
                                        <div class="message ${esMio ? 'message-sent' : 'message-received'}">
                                            <div class="message-header">
                                                <span class="message-sender">${usuario.name || usuario.email}</span>
                                                <span class="message-time">${new Date(mensaje.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                            </div>
                                            <div class="message-content">${mensaje.text}</div>
                                            ${!mensaje.leido && esMio ? '<div style="font-size: 0.7rem; text-align: right; margin-top: 5px;">‚úì Enviado</div>' : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <div class="chat-input-area">
                                <input type="text" 
                                       id="chat-input-detalle-${chatActivo.id}" 
                                       class="chat-input" 
                                       placeholder="Escribe tu mensaje..." 
                                       onkeypress="if(event.key === 'Enter') enviarMensajeChat(${chatActivo.id}, ${aviso.id})">
                                <button class="btn btn-primary" onclick="enviarMensajeChat(${chatActivo.id}, ${aviso.id})">
                                    Enviar
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div class="chat-section">
                            <div class="chat-header">
                                <h3 style="margin: 0; font-size: 1.2rem;">üí¨ Chat</h3>
                            </div>
                            <div style="padding: 40px 20px; text-align: center; color: var(--gray);">
                                <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;">üí¨</div>
                                <h3 style="margin-bottom: 15px; color: var(--dark);">No hay chat activo</h3>
                                <p style="margin-bottom: 25px;">
                                    ${esCreador ? 
                                        'Selecciona una propuesta para iniciar un chat con el vendedor' : 
                                        'Env√≠a una propuesta para iniciar un chat con el comprador'
                                    }
                                </p>
                                ${!esCreador && currentUser.role === 'vendedor' && aviso.estado === 'abierto' ? `
                                    <button class="btn btn-primary" onclick="mostrarEnviarPropuesta(${aviso.id})">
                                        üì® Enviar Propuesta y Chatear
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `}
                    
                    <!-- SECCI√ìN ACCIONES R√ÅPIDAS -->
                    <div class="card" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>‚ö°</span>
                            <span>Acciones R√°pidas</span>
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${currentUser.role === 'vendedor' && aviso.estado === 'abierto' && !esCreador ? `
                                <button class="btn btn-secondary btn-block" onclick="mostrarEnviarPropuesta(${aviso.id})">
                                    üì® Enviar Propuesta
                                </button>
                            ` : ''}
                            
                            <button class="btn btn-outline btn-block" onclick="compartirAviso(${aviso.id})">
                                üì§ Compartir Aviso
                            </button>
                            
                            ${esCreador ? `
                                <button class="btn btn-outline btn-block" onclick="editarAviso(${aviso.id})">
                                    ‚úèÔ∏è Editar Aviso
                                </button>
                                <button class="btn btn-danger btn-block" onclick="eliminarAviso(${aviso.id})">
                                    üóëÔ∏è Eliminar Aviso
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Auto-scroll al final del chat si existe
            setTimeout(() => {
                if (chatActivo) {
                    const messagesContainer = document.getElementById(`chat-messages-detalle-${chatActivo.id}`);
                    if (messagesContainer) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
            }, 100);
        }

        // ============================================
        // FUNCIONES DE FILTROS
        // ============================================
        function toggleFilters() {
            const filters = document.getElementById('filters-container');
            filters.classList.toggle('hidden');
        }

        function togglePropuestasFilters() {
            const filters = document.getElementById('propuestas-filters');
            filters.classList.toggle('hidden');
        }

        function aplicarFiltros() {
            showToast('Filtros aplicados correctamente', 'success');
            loadAvisos();
        }

        function aplicarPropuestasFiltros() {
            showToast('Filtros aplicados correctamente', 'success');
            loadPropuestas();
        }

        function limpiarFiltros() {
            // Resetear todos los filtros
            document.getElementById('filter-tipo').value = '';
            document.getElementById('filter-presupuesto').value = '';
            document.getElementById('filter-estado').value = '';
            document.getElementById('filter-urgencia').value = '';
            
            // Limpiar filtros espec√≠ficos de inmuebles
            const inmuebleFilters = document.getElementById('inmueble-filters');
            if (inmuebleFilters) {
                inmuebleFilters.classList.add('hidden');
                document.getElementById('filter-inmueble-operacion').value = '';
                document.getElementById('filter-inmueble-tipo').value = '';
                document.getElementById('filter-inmueble-region').value = '';
                document.getElementById('filter-inmueble-comuna').value = '';
                document.getElementById('filter-inmueble-dormitorios').value = '';
                document.getElementById('filter-inmueble-banos').value = '';
                document.getElementById('filter-inmueble-sup-util-min').value = '';
                document.getElementById('filter-inmueble-sup-util-max').value = '';
                document.getElementById('filter-inmueble-sup-total-min').value = '';
                document.getElementById('filter-inmueble-sup-total-max').value = '';
                
                // Desmarcar checkboxes de caracter√≠sticas
                const checkboxes = document.querySelectorAll('#inmueble-filters input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
            }
            
            showToast('Filtros limpiados', 'info');
            loadAvisos();
        }

        function limpiarPropuestasFiltros() {
            document.getElementById('filter-propuesta-estado').value = '';
            document.getElementById('filter-propuesta-tipo').value = '';
            document.getElementById('filter-propuesta-orden').value = 'fecha';
            showToast('Filtros limpiados', 'info');
            loadPropuestas();
        }

        // ============================================
        // FUNCIONES DE PROPUESTAS
        // ============================================
        function mostrarEnviarPropuesta(avisoId) {
            const data = getData();
            const aviso = data.avisos.find(a => a.id === avisoId);
            
            if (!aviso || aviso.estado !== 'abierto') {
                showToast('Este aviso no est√° disponible para propuestas', 'warning');
                return;
            }
            
            // Verificar si ya envi√≥ propuesta
            const propuestaExistente = data.propuestas.find(p => 
                p.avisoId === avisoId && p.vendedorId === currentUser.id
            );
            
            if (propuestaExistente) {
                if (confirm('Ya has enviado una propuesta a este aviso. ¬øDeseas enviar una nueva?')) {
                    // Eliminar la propuesta anterior
                    data.propuestas = data.propuestas.filter(p => p.id !== propuestaExistente.id);
                    
                    // Eliminar de la lista de propuestas del aviso
                    const index = aviso.propuestas.indexOf(propuestaExistente.id);
                    if (index > -1) {
                        aviso.propuestas.splice(index, 1);
                    }
                    
                    // Eliminar chat asociado
                    data.chats = data.chats.filter(c => c.propuestaId !== propuestaExistente.id);
                    
                    saveData(data);
                } else {
                    return;
                }
            }
            
            document.getElementById('propuesta-aviso-id').value = avisoId;
            document.getElementById('propuesta-modal-title').textContent = `Enviar propuesta: ${aviso.titulo}`;
            document.getElementById('propuesta-presupuesto-info').textContent = 
                `Presupuesto m√°ximo del comprador: $${aviso.presupuesto.toLocaleString()}`;
            document.getElementById('propuesta-precio').value = '';
            document.getElementById('propuesta-precio').max = aviso.presupuesto * 2; // Permitir hasta el doble
            document.getElementById('propuesta-mensaje').value = '';
            document.getElementById('propuesta-detalles').value = '';
            
            showModal('enviar-propuesta-modal');
        }

        function enviarPropuesta(event) {
            event.preventDefault();
            
            const avisoId = parseInt(document.getElementById('propuesta-aviso-id').value);
            const precio = parseInt(document.getElementById('propuesta-precio').value);
            const mensaje = document.getElementById('propuesta-mensaje').value;
            const detalles = document.getElementById('propuesta-detalles').value;
            
            if (!precio || precio <= 0) {
                showToast('Ingresa un precio v√°lido', 'error');
                return;
            }
            
            if (!mensaje.trim()) {
                showToast('El mensaje es requerido', 'error');
                return;
            }
            
            const data = getData();
            const aviso = data.avisos.find(a => a.id === avisoId);
            
            if (!aviso || aviso.estado !== 'abierto') {
                showToast('Este aviso ya no est√° disponible', 'error');
                closeModal('enviar-propuesta-modal');
                return;
            }
            
            // Crear nueva propuesta
            const nuevaPropuesta = {
                id: data.nextIds.propuestas++,
                avisoId: avisoId,
                vendedorId: currentUser.id,
                precio: precio,
                mensaje: mensaje,
                detalles: detalles,
                estado: 'pendiente',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                destacada: false
            };
            
            data.propuestas.push(nuevaPropuesta);
            
            // A√±adir propuesta al aviso
            if (!aviso.propuestas) aviso.propuestas = [];
            aviso.propuestas.push(nuevaPropuesta.id);
            
            // Actualizar contador del usuario
            const user = data.users.find(u => u.id === currentUser.id);
            user.totalPropuestas = (user.totalPropuestas || 0) + 1;
            
            // Crear notificaci√≥n para el comprador
            const comprador = data.users.find(u => u.id === aviso.userId);
            data.notifications.push({
                id: data.nextIds.notifications++,
                userId: comprador.id,
                type: "propuesta_nueva",
                title: "¬°Nueva propuesta recibida!",
                message: `${user.name || user.email} envi√≥ una propuesta a tu aviso: "${aviso.titulo}"`,
                data: { avisoId: avisoId, propuestaId: nuevaPropuesta.id },
                read: false,
                createdAt: new Date().toISOString()
            });
            
            // Crear chat autom√°ticamente
            const nuevoChat = {
                id: data.nextIds.chats++,
                avisoId: avisoId,
                propuestaId: nuevaPropuesta.id,
                participantes: [aviso.userId, currentUser.id],
                mensajes: [
                    {
                        id: 1,
                        userId: currentUser.id,
                        text: `Hola, he enviado una propuesta por $${precio.toLocaleString()}. ${mensaje.substring(0, 50)}...`,
                        timestamp: new Date().toISOString(),
                        leido: false
                    }
                ],
                unreadCount: 1,
                lastMessage: `Hola, he enviado una propuesta por $${precio.toLocaleString()}. ${mensaje.substring(0, 50)}...`,
                lastMessageTime: new Date().toISOString(),
                activo: true
            };
            
            data.chats.push(nuevoChat);
            
            saveData(data);
            
            closeModal('enviar-propuesta-modal');
            showToast('¬°Propuesta enviada exitosamente! Se ha iniciado un chat con el comprador.', 'success');
            
            // Redirigir al detalle del aviso
            currentAvisoId = avisoId;
            showView('detalle-aviso');
        }

        function loadPropuestas() {
            const data = getData();
            const container = document.getElementById('propuestas-list');
            
            if (!container) return;
            
            let propuestas = [];
            
            if (currentUser.role === 'comprador') {
                // Obtener avisos del comprador
                const misAvisosIds = data.avisos
                    .filter(a => a.userId === currentUser.id)
                    .map(a => a.id);
                
                // Obtener propuestas para esos avisos
                propuestas = data.propuestas
                    .filter(p => misAvisosIds.includes(p.avisoId));
            } else if (currentUser.role === 'vendedor') {
                // Obtener propuestas del vendedor
                propuestas = data.propuestas
                    .filter(p => p.vendedorId === currentUser.id);
            }
            
            // Aplicar filtros
            const estado = document.getElementById('filter-propuesta-estado')?.value;
            const tipo = document.getElementById('filter-propuesta-tipo')?.value;
            const orden = document.getElementById('filter-propuesta-orden')?.value;
            
            if (estado) propuestas = propuestas.filter(p => p.estado === estado);
            if (tipo) {
                propuestas = propuestas.filter(p => {
                    const aviso = data.avisos.find(a => a.id === p.avisoId);
                    return aviso && aviso.tipo === tipo;
                });
            }
            
            // Ordenar
            if (orden === 'fecha') {
                propuestas.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            } else if (orden === 'precio_asc') {
                propuestas.sort((a, b) => a.precio - b.precio);
            } else if (orden === 'precio_desc') {
                propuestas.sort((a, b) => b.precio - a.precio);
            }
            
            if (propuestas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No hay propuestas</h3>
                        <p>${currentUser.role === 'comprador' ? 
                            'Crea avisos para recibir propuestas de vendedores' : 
                            'Busca avisos activos y env√≠a tu primera propuesta'
                        }</p>
                        ${currentUser.role === 'comprador' ? 
                            '<button class="btn btn-primary" onclick="showCreateAvisoModal()">Crear Aviso</button>' : 
                            '<button class="btn btn-primary" onclick="showView(\'avisos\')">Ver Avisos Disponibles</button>'
                        }
                    </div>
                `;
                return;
            }
            
            container.innerHTML = propuestas.map(propuesta => {
                const aviso = data.avisos.find(a => a.id === propuesta.avisoId);
                const otroUsuario = currentUser.role === 'comprador' ? 
                    data.users.find(u => u.id === propuesta.vendedorId) :
                    data.users.find(u => u.id === aviso.userId);
                
                const chat = data.chats.find(c => c.propuestaId === propuesta.id);
                
                if (!aviso || !otroUsuario) return '';
                
                // Icono seg√∫n tipo
                const tipoIcon = {
                    'inmueble': 'üè†',
                    'auto': 'üöó',
                    'motos': 'üèçÔ∏è',
                    'tecnologia': 'üíª',
                    'servicios': 'üîß',
                    'otros': 'üì¶'
                }[aviso.tipo] || 'üìã';
                
                return `
                    <div class="propuesta-card" onclick="verPropuestaDetalle(${propuesta.id}, ${aviso.id})">
                        <div class="propuesta-header">
                            <div>
                                <div class="propuesta-title">${aviso.titulo}</div>
                                <div class="aviso-status">
                                    <span class="badge ${propuesta.estado === 'pendiente' ? 'badge-warning' : 
                                                      propuesta.estado === 'aceptada' ? 'badge-success' : 
                                                      propuesta.estado === 'rechazada' ? 'badge-danger' : 'badge-info'}">
                                        ${propuesta.estado}
                                    </span>
                                    <span class="badge badge-light">
                                        ${tipoIcon} ${aviso.tipo}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="propuesta-meta">
                            <span><strong>üí∞ Precio:</strong> $${propuesta.precio.toLocaleString()}</span>
                            <span><strong>üìÖ Fecha:</strong> ${new Date(propuesta.createdAt).toLocaleDateString()}</span>
                            <span><strong>üí¨ Chat:</strong> ${chat ? (chat.unreadCount > 0 ? `${chat.unreadCount} nuevos` : 'Activo') : 'No iniciado'}</span>
                        </div>
                        
                        <div class="propuesta-description">
                            ${propuesta.mensaje.substring(0, 150)}...
                        </div>
                        
                        <div class="propuesta-actions">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); verPropuestaDetalle(${propuesta.id}, ${aviso.id})">
                                Ver Detalles
                            </button>
                            
                            ${chat ? `
                                <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); abrirChat(${chat.id}, ${aviso.id})">
                                    üí¨ ${chat.unreadCount > 0 ? `Chat (${chat.unreadCount})` : 'Abrir Chat'}
                                </button>
                            ` : currentUser.role === 'vendedor' ? `
                                <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); iniciarChatConComprador(${aviso.id}, ${propuesta.id})">
                                    üí¨ Iniciar Chat
                                </button>
                            ` : ''}
                            
                            ${currentUser.role === 'comprador' && propuesta.estado === 'pendiente' ? `
                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); aceptarPropuesta(${propuesta.id}, ${aviso.id})">
                                    ‚úÖ Aceptar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function verPropuestaDetalle(propuestaId, avisoId) {
            currentPropuestaId = propuestaId;
            currentAvisoId = avisoId;
            showView('detalle-aviso');
        }

        // ============================================
        // FUNCIONES DE CHAT
        // ============================================
        function abrirChat(chatId, avisoId) {
            const data = getData();
            const chat = data.chats.find(c => c.id === chatId);
            
            if (!chat) {
                showToast('Chat no encontrado', 'error');
                return;
            }
            
            // Marcar mensajes como le√≠dos
            chat.mensajes.forEach(mensaje => {
                if (mensaje.userId !== currentUser.id) {
                    mensaje.leido = true;
                }
            });
            chat.unreadCount = 0;
            saveData(data);
            
            // Actualizar notificaciones
            updateNotifications();
            
            // Redirigir al aviso con el chat abierto
            currentAvisoId = avisoId;
            showView('detalle-aviso');
        }

        function iniciarChatConComprador(avisoId, propuestaId) {
            const data = getData();
            const aviso = data.avisos.find(a => a.id === avisoId);
            const propuesta = data.propuestas.find(p => p.id === propuestaId);
            
            if (!aviso || !propuesta) {
                showToast('No se pudo iniciar el chat', 'error');
                return;
            }
            
            // Verificar si ya existe un chat
            let chat = data.chats.find(c => c.propuestaId === propuestaId);
            
            if (!chat) {
                // Crear nuevo chat
                chat = {
                    id: data.nextIds.chats++,
                    avisoId: avisoId,
                    propuestaId: propuestaId,
                    participantes: [aviso.userId, currentUser.id],
                    mensajes: [
                        {
                            id: 1,
                            userId: currentUser.id,
                            text: `Hola, he enviado una propuesta por $${propuesta.precio.toLocaleString()}. ¬øTe interesa conversar m√°s detalles?`,
                            timestamp: new Date().toISOString(),
                            leido: false
                        }
                    ],
                    unreadCount: 1,
                    lastMessage: `Hola, he enviado una propuesta por $${propuesta.precio.toLocaleString()}. ¬øTe interesa conversar m√°s detalles?`,
                    lastMessageTime: new Date().toISOString(),
                    activo: true
                };
                
                data.chats.push(chat);
                saveData(data);
                
                // Crear notificaci√≥n
                data.notifications.push({
                    id: data.nextIds.notifications++,
                    userId: aviso.userId,
                    type: "mensaje_nuevo",
                    title: "Nuevo mensaje en el chat",
                    message: `${currentUser.name || currentUser.email} inici√≥ un chat sobre tu aviso`,
                    data: { chatId: chat.id, avisoId: avisoId },
                    read: false,
                    createdAt: new Date().toISOString()
                });
                
                saveData(data);
            }
            
            // Redirigir al aviso con el chat abierto
            currentAvisoId = avisoId;
            showView('detalle-aviso');
        }

        function iniciarChatConVendedor(avisoId, propuestaId) {
            const data = getData();
            const aviso = data.avisos.find(a => a.id === avisoId);
            const propuesta = data.propuestas.find(p => p.id === propuestaId);
            
            if (!aviso || !propuesta) {
                showToast('No se pudo iniciar el chat', 'error');
                return;
            }
            
            // Verificar si ya existe un chat
            let chat = data.chats.find(c => c.propuestaId === propuestaId);
            
            if (!chat) {
                // Crear nuevo chat
                chat = {
                    id: data.nextIds.chats++,
                    avisoId: avisoId,
                    propuestaId: propuestaId,
                    participantes: [aviso.userId, propuesta.vendedorId],
                    mensajes: [
                        {
                            id: 1,
                            userId: currentUser.id,
                            text: `Hola, estoy interesado en tu propuesta de $${propuesta.precio.toLocaleString()}. ¬øPodemos conversar m√°s detalles?`,
                            timestamp: new Date().toISOString(),
                            leido: false
                        }
                    ],
                    unreadCount: 1,
                    lastMessage: `Hola, estoy interesado en tu propuesta de $${propuesta.precio.toLocaleString()}. ¬øPodemos conversar m√°s detalles?`,
                    lastMessageTime: new Date().toISOString(),
                    activo: true
                };
                
                data.chats.push(chat);
                saveData(data);
                
                // Crear notificaci√≥n
                data.notifications.push({
                    id: data.nextIds.notifications++,
                    userId: propuesta.vendedorId,
                    type: "mensaje_nuevo",
                    title: "Nuevo mensaje en el chat",
                    message: `${currentUser.name || currentUser.email} inici√≥ un chat sobre tu propuesta`,
                    data: { chatId: chat.id, avisoId: avisoId },
                    read: false,
                    createdAt: new Date().toISOString()
                });
                
                saveData(data);
            }
            
            // Redirigir al aviso con el chat abierto
            currentAvisoId = avisoId;
            showView('detalle-aviso');
        }

        function enviarMensajeChat(chatId, avisoId) {
            const input = document.getElementById(`chat-input-detalle-${chatId}`);
            const texto = input.value.trim();
            
            if (!texto) return;
            
            const data = getData();
            const chat = data.chats.find(c => c.id === chatId);
            
            if (!chat) return;
            
            const nuevoMensaje = {
                id: chat.mensajes.length + 1,
                userId: currentUser.id,
                text: texto,
                timestamp: new Date().toISOString(),
                leido: false
            };
            
            chat.mensajes.push(nuevoMensaje);
            chat.lastMessage = texto;
            chat.lastMessageTime = new Date().toISOString();
            chat.unreadCount += 1;
            chat.activo = true;
            
            // Crear notificaci√≥n para el otro participante
            const otroUsuarioId = chat.participantes.find(id => id !== currentUser.id);
            data.notifications.push({
                id: data.nextIds.notifications++,
                userId: otroUsuarioId,
                type: "mensaje_nuevo",
                title: "Nuevo mensaje",
                message: `${currentUser.name || currentUser.email}: ${texto.substring(0, 50)}...`,
                data: { chatId: chat.id, avisoId: avisoId },
                read: false,
                createdAt: new Date().toISOString()
            });
            
            saveData(data);
            
            // Limpiar input y actualizar vista
            input.value = '';
            loadDetalleAviso(avisoId);
            
            // Actualizar notificaciones
            updateNotifications();
        }

        function loadChats() {
            const data = getData();
            const container = document.getElementById('chats-list');
            
            if (!container) return;
            
            // Obtener chats del usuario
            const userChats = data.chats.filter(c => c.participantes.includes(currentUser.id));
            
            if (userChats.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <h3>No tienes conversaciones</h3>
                        <p>${currentUser.role === 'comprador' ? 
                            'Acepta una propuesta para iniciar un chat con el vendedor' : 
                            'Env√≠a una propuesta para iniciar un chat con el comprador'
                        }</p>
                        <button class="btn btn-primary" onclick="showView('${currentUser.role === 'comprador' ? 'propuestas' : 'avisos'}')">
                            ${currentUser.role === 'comprador' ? 'Ver Propuestas' : 'Ver Avisos Disponibles'}
                        </button>
                    </div>
                `;
                return;
            }
            
            // Ordenar por √∫ltimo mensaje (m√°s recientes primero)
            userChats.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            
            container.innerHTML = userChats.map(chat => {
                const otroUsuarioId = chat.participantes.find(id => id !== currentUser.id);
                const otroUsuario = data.users.find(u => u.id === otroUsuarioId);
                const aviso = data.avisos.find(a => a.id === chat.avisoId);
                const propuesta = data.propuestas.find(p => p.id === chat.propuestaId);
                
                if (!otroUsuario || !aviso) return '';
                
                // Icono seg√∫n tipo
                const tipoIcon = {
                    'inmueble': 'üè†',
                    'auto': 'üöó',
                    'motos': 'üèçÔ∏è',
                    'tecnologia': 'üíª',
                    'servicios': 'üîß',
                    'otros': 'üì¶'
                }[aviso.tipo] || 'üìã';
                
                return `
                    <div class="card" style="cursor: pointer;" onclick="abrirChat(${chat.id}, ${aviso.id})">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div class="user-avatar" style="background: ${otroUsuario.avatarColor}">
                                ${(otroUsuario.name || otroUsuario.email).charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div>
                                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">
                                            ${otroUsuario.name || otroUsuario.email}
                                        </div>
                                        <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 8px;">
                                            ${tipoIcon} ${aviso.titulo.substring(0, 50)}...
                                        </div>
                                        <div style="font-size: 0.95rem; color: var(--dark);">
                                            ${chat.lastMessage.substring(0, 80)}...
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 8px;">
                                            ${new Date(chat.lastMessageTime).toLocaleDateString()}
                                        </div>
                                        ${chat.unreadCount > 0 ? `
                                            <span class="badge badge-warning">${chat.unreadCount} nuevo${chat.unreadCount > 1 ? 's' : ''}</span>
                                        ` : ''}
                                    </div>
                                </div>
                                ${propuesta ? `
                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--gray-light);">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 600; color: var(--primary);">
                                                $${propuesta.precio.toLocaleString()}
                                            </span>
                                            <span class="badge ${propuesta.estado === 'pendiente' ? 'badge-warning' : 
                                                               propuesta.estado === 'aceptada' ? 'badge-success' : 
                                                               propuesta.estado === 'rechazada' ? 'badge-danger' : 'badge-info'}">
                                                ${propuesta.estado}
                                            </span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // FUNCIONES DE NOTIFICACIONES
        // ============================================
        function updateNotificationBadges() {
            const data = getData();
            notifications = data.notifications.filter(n => n.userId === currentUser.id);
            
            const unreadCount = notifications.filter(n => !n.read).length;
            
            // Actualizar badges
            document.getElementById('notification-count').textContent = unreadCount;
            document.getElementById('dropdown-notif-count').textContent = unreadCount;
            
            if (unreadCount > 0) {
                document.getElementById('notification-count').classList.remove('hidden');
                document.getElementById('dropdown-notif-count').classList.remove('hidden');
            } else {
                document.getElementById('notification-count').classList.add('hidden');
                document.getElementById('dropdown-notif-count').classList.add('hidden');
            }
            
            // Actualizar contador de mensajes no le√≠dos en chats
            const userChats = data.chats.filter(c => c.participantes.includes(currentUser.id));
            unreadMessages = userChats.reduce((total, chat) => total + (chat.unreadCount || 0), 0);
            
            document.getElementById('unread-chat-count').textContent = unreadMessages;
            document.getElementById('dropdown-chat-count').textContent = unreadMessages;
            document.getElementById('unread-chats-count').textContent = unreadMessages;
            
            if (unreadMessages > 0) {
                document.getElementById('unread-chat-count').classList.remove('hidden');
                document.getElementById('dropdown-chat-count').classList.remove('hidden');
                document.getElementById('unread-chats-badge').classList.remove('hidden');
                document.getElementById('mobile-chat-notification').classList.remove('hidden');
            } else {
                document.getElementById('unread-chat-count').classList.add('hidden');
                document.getElementById('dropdown-chat-count').classList.add('hidden');
                document.getElementById('unread-chats-badge').classList.add('hidden');
                document.getElementById('mobile-chat-notification').classList.add('hidden');
            }
        }

        function updateNotifications() {
            updateNotificationBadges();
        }

        function toggleNotifications() {
            const modal = document.getElementById('notifications-modal');
            const list = document.getElementById('notifications-list');
            
            // Marcar todas como le√≠das
            const data = getData();
            data.notifications.forEach(n => {
                if (n.userId === currentUser.id && !n.read) {
                    n.read = true;
                }
            });
            saveData(data);
            updateNotifications();
            
            // Mostrar notificaciones
            list.innerHTML = notifications.length > 0 ? notifications.map(notif => {
                const icon = notif.type === 'propuesta_nueva' ? 'üì®' : 
                            notif.type === 'propuesta_aceptada' ? '‚úÖ' : 
                            notif.type === 'mensaje_nuevo' ? 'üí¨' : 
                            notif.type === 'aviso_nuevo' ? 'üìù' : '‚ÑπÔ∏è';
                
                return `
                    <div class="notification-item" onclick="handleNotificationClick(${notif.id})">
                        <div class="notification-icon">${icon}</div>
                        <div class="notification-content">
                            <div style="font-weight: 700; margin-bottom: 5px;">${notif.title}</div>
                            <div style="color: var(--dark); margin-bottom: 5px;">${notif.message}</div>
                            <div class="notification-time">${new Date(notif.createdAt).toLocaleString()}</div>
                        </div>
                        ${!notif.read ? '<div style="width: 8px; height: 8px; border-radius: 50%; background-color: var(--primary);"></div>' : ''}
                    </div>
                `;
            }).join('') : `
                <div class="empty-state" style="padding: 40px 20px;">
                    <div class="empty-state-icon">üîî</div>
                    <h3>No hay notificaciones</h3>
                    <p>Todas tus notificaciones est√°n al d√≠a</p>
                </div>
            `;
            
            showModal('notifications-modal');
        }

        function handleNotificationClick(notificationId) {
            const data = getData();
            const notification = data.notifications.find(n => n.id === notificationId);
            
            if (!notification) return;
            
            // Marcar como le√≠da
            notification.read = true;
            saveData(data);
            updateNotifications();
            
            // Navegar seg√∫n el tipo de notificaci√≥n
            if (notification.data.avisoId) {
                currentAvisoId = notification.data.avisoId;
                showView('detalle-aviso');
            } else if (notification.data.chatId) {
                const chat = data.chats.find(c => c.id === notification.data.chatId);
                if (chat) {
                    abrirChat(chat.id, chat.avisoId);
                }
            }
            
            closeModal('notifications-modal');
        }

        // ============================================
        // FUNCIONES DE ACCIONES
        // ============================================
        function aceptarPropuesta(propuestaId, avisoId) {
            if (!confirm('¬øEst√°s seguro de aceptar esta propuesta? Esta acci√≥n iniciar√° una negociaci√≥n con el vendedor.')) {
                return;
            }
            
            const data = getData();
            const propuesta = data.propuestas.find(p => p.id === propuestaId);
            const aviso = data.avisos.find(a => a.id === avisoId);
            
            if (!propuesta || !aviso) {
                showToast('No se pudo aceptar la propuesta', 'error');
                return;
            }
            
            // Cambiar estado de la propuesta
            propuesta.estado = 'aceptada';
            propuesta.updatedAt = new Date().toISOString();
            
            // Cambiar estado del aviso a negociando
            aviso.estado = 'negociando';
            aviso.updatedAt = new Date().toISOString();
            
            // Rechazar otras propuestas pendientes
            data.propuestas.forEach(p => {
                if (p.avisoId === avisoId && p.id !== propuestaId && p.estado === 'pendiente') {
                    p.estado = 'rechazada';
                    p.updatedAt = new Date().toISOString();
                }
            });
            
            // Crear notificaci√≥n para el vendedor
            data.notifications.push({
                id: data.nextIds.notifications++,
                userId: propuesta.vendedorId,
                type: "propuesta_aceptada",
                title: "¬°Propuesta aceptada!",
                message: `${currentUser.name || currentUser.email} acept√≥ tu propuesta de $${propuesta.precio.toLocaleString()}`,
                data: { avisoId: avisoId, propuestaId: propuestaId },
                read: false,
                createdAt: new Date().toISOString()
            });
            
            saveData(data);
            showToast('¬°Propuesta aceptada! El aviso ahora est√° en negociaci√≥n.', 'success');
            
            // Actualizar vista
            loadDetalleAviso(avisoId);
        }

        function rechazarPropuesta(propuestaId, avisoId) {
            if (!confirm('¬øEst√°s seguro de rechazar esta propuesta?')) {
                return;
            }
            
            const data = getData();
            const propuesta = data.propuestas.find(p => p.id === propuestaId);
            
            if (!propuesta) {
                showToast('No se pudo rechazar la propuesta', 'error');
                return;
            }
            
            propuesta.estado = 'rechazada';
            propuesta.updatedAt = new Date().toISOString();
            
            // Crear notificaci√≥n para el vendedor
            data.notifications.push({
                id: data.nextIds.notifications++,
                userId: propuesta.vendedorId,
                type: "propuesta_rechazada",
                title: "Propuesta rechazada",
                message: `${currentUser.name || currentUser.email} rechaz√≥ tu propuesta`,
                data: { avisoId: avisoId, propuestaId: propuestaId },
                read: false,
                createdAt: new Date().toISOString()
            });
            
            saveData(data);
            showToast('Propuesta rechazada', 'info');
            
            // Actualizar vista
            loadDetalleAviso(avisoId);
        }

        function cambiarEstadoAviso(avisoId, nuevoEstado) {
            const data = getData();
            const aviso = data.avisos.find(a => a.id === avisoId);
            
            if (!aviso) {
                showToast('No se pudo cambiar el estado', 'error');
                return;
            }
            
            const estadoAnterior = aviso.estado;
            aviso.estado = nuevoEstado;
            aviso.updatedAt = new Date().toISOString();
            
            saveData(data);
            
            const mensaje = nuevoEstado === 'cerrado' ? 'Aviso cerrado exitosamente' :
                          nuevoEstado === 'negociando' ? 'Aviso marcado como en negociaci√≥n' :
                          'Estado del aviso actualizado';
            
            showToast(mensaje, 'success');
            loadDetalleAviso(avisoId);
        }

        function editarAviso(avisoId) {
            const data = getData();
            const aviso = data.avisos.find(a => a.id === avisoId);
            
            if (!aviso) {
                showToast('No se pudo cargar el aviso', 'error');
                return;
            }
            
            // Llenar el formulario
            document.getElementById('editar-aviso-id').value = aviso.id;
            document.getElementById('editar-aviso-titulo').value = aviso.titulo;
            document.getElementById('editar-aviso-descripcion').value = aviso.descripcion;
            document.getElementById('editar-aviso-presupuesto').value = aviso.presupuesto;
            document.getElementById('editar-aviso-zona').value = aviso.zona;
            document.getElementById('editar-aviso-urgencia').value = aviso.urgencia;
            document.getElementById('editar-aviso-estado').value = aviso.estado;
            
            showModal('editar-aviso-modal');
        }

        function guardarEdicionAviso(event) {
            event.preventDefault();
            
            const avisoId = parseInt(document.getElementById('editar-aviso-id').value);
            const data = getData();
            const aviso = data.avisos.find(a => a.id === avisoId);
            
            if (!aviso) {
                showToast('No se pudo guardar los cambios', 'error');
                return;
            }
            
            // Actualizar aviso
            aviso.titulo = document.getElementById('editar-aviso-titulo').value;
            aviso.descripcion = document.getElementById('editar-aviso-descripcion').value;
            aviso.presupuesto = parseInt(document.getElementById('editar-aviso-presupuesto').value);
            aviso.zona = document.getElementById('editar-aviso-zona').value;
            aviso.urgencia = document.getElementById('editar-aviso-urgencia').value;
            aviso.estado = document.getElementById('editar-aviso-estado').value;
            aviso.updatedAt = new Date().toISOString();
            
            saveData(data);
            closeModal('editar-aviso-modal');
            showToast('Aviso actualizado exitosamente', 'success');
            
            // Actualizar vista
            loadDetalleAviso(avisoId);
        }

        function eliminarAviso(avisoId) {
            if (!confirm('¬øEst√°s seguro de eliminar este aviso? Esta acci√≥n no se puede deshacer y tambi√©n eliminar√° todas las propuestas asociadas.')) {
                return;
            }
            
            const data = getData();
            
            // Eliminar propuestas asociadas
            data.propuestas = data.propuestas.filter(p => p.avisoId !== avisoId);
            
            // Eliminar chats asociados
            data.chats = data.chats.filter(c => c.avisoId !== avisoId);
            
            // Eliminar aviso
            data.avisos = data.avisos.filter(a => a.id !== avisoId);
            
            // Actualizar contador del usuario
            const user = data.users.find(u => u.id === currentUser.id);
            user.totalAvisos = Math.max(0, (user.totalAvisos || 0) - 1);
            
            saveData(data);
            showToast('Aviso eliminado exitosamente', 'success');
            
            // Redirigir a avisos
            showView('avisos');
        }

        function compartirAviso(avisoId) {
            const data = getData();
            const aviso = data.avisos.find(a => a.id === avisoId);
            
            if (!aviso) {
                showToast('No se pudo compartir el aviso', 'error');
                return;
            }
            
            // En un entorno real, esto usar√≠a las APIs de compartir
            // Por ahora, mostramos un mensaje
            const url = window.location.href.split('#')[0] + `#aviso-${avisoId}`;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Enlace copiado al portapapeles. Comp√°rtelo con tus contactos.', 'success');
            });
        }

        // ============================================
        // FUNCIONES DEL DASHBOARD
        // ============================================
        function updateDashboard() {
            if (!currentUser) return;
            
            const data = getData();
            
            if (currentUser.role === 'comprador') {
                const misAvisos = data.avisos.filter(a => a.userId === currentUser.id);
                const propuestasRecibidas = data.propuestas.filter(p => 
                    misAvisos.some(a => a.id === p.avisoId)
                );
                const chatsActivos = data.chats.filter(c => 
                    c.participantes.includes(currentUser.id) && c.activo
                );
                
                document.getElementById('stat-avisos-activos').textContent = 
                    misAvisos.filter(a => a.estado === 'abierto').length;
                document.getElementById('stat-propuestas-total').textContent = propuestasRecibidas.length;
                document.getElementById('stat-chats-activos').textContent = chatsActivos.length;
                document.getElementById('stat-negociaciones').textContent = 
                    misAvisos.filter(a => a.estado === 'negociando').length;
                
                // Avisos recientes
                const avisosContainer = document.getElementById('dashboard-avisos');
                const avisosRecientes = misAvisos.slice(0, 4);
                
                avisosContainer.innerHTML = avisosRecientes.length > 0 ? avisosRecientes.map(aviso => {
                    // Icono seg√∫n tipo
                    const tipoIcon = {
                        'inmueble': 'üè†',
                        'auto': 'üöó',
                        'motos': 'üèçÔ∏è',
                        'tecnologia': 'üíª',
                        'servicios': 'üîß',
                        'otros': 'üì¶'
                    }[aviso.tipo] || 'üìã';
                    
                    return `
                        <div class="aviso-card" onclick="verDetalleAviso(${aviso.id})">
                            <div class="aviso-title">${aviso.titulo.substring(0, 40)}...</div>
                            <div style="display: flex; gap: 10px; margin: 15px 0;">
                                <span class="badge ${aviso.estado === 'abierto' ? 'badge-success' : 
                                                  aviso.estado === 'negociando' ? 'badge-warning' : 
                                                  aviso.estado === 'cerrado' ? 'badge-info' : 'badge-danger'}">
                                    ${aviso.estado}
                                </span>
                                <span class="badge badge-light">${tipoIcon} ${aviso.tipo}</span>
                                <span class="badge badge-light">$${aviso.presupuesto.toLocaleString()}</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 15px;">
                                ${aviso.propuestas?.length || 0} propuestas
                            </div>
                            <button class="btn btn-sm btn-primary btn-block" onclick="event.stopPropagation(); verDetalleAviso(${aviso.id})">
                                Ver Detalles
                            </button>
                        </div>
                    `;
                }).join('') : '<div class="empty-state" style="padding: 30px;">No tienes avisos activos</div>';
                
                // Propuestas recientes
                const propuestasContainer = document.getElementById('dashboard-propuestas');
                const propuestasRecientes = propuestasRecibidas.slice(0, 4);
                
                propuestasContainer.innerHTML = propuestasRecientes.length > 0 ? propuestasRecientes.map(propuesta => {
                    const aviso = data.avisos.find(a => a.id === propuesta.avisoId);
                    const vendedor = data.users.find(u => u.id === propuesta.vendedorId);
                    
                    // Icono seg√∫n tipo
                    const tipoIcon = {
                        'inmueble': 'üè†',
                        'auto': 'üöó',
                        'motos': 'üèçÔ∏è',
                        'tecnologia': 'üíª',
                        'servicios': 'üîß',
                        'otros': 'üì¶'
                    }[aviso.tipo] || 'üìã';
                    
                    return `
                        <div class="propuesta-card" onclick="verDetalleAviso(${aviso.id})">
                            <div style="font-weight: 700; margin-bottom: 10px;">${tipoIcon} ${aviso.titulo.substring(0, 30)}...</div>
                            <div style="font-size: 1.2rem; font-weight: 800; color: var(--primary); margin-bottom: 10px;">
                                $${propuesta.precio.toLocaleString()}
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 15px;">
                                De: ${vendedor.name || vendedor.email}
                            </div>
                            <button class="btn btn-sm btn-primary btn-block" onclick="event.stopPropagation(); verDetalleAviso(${aviso.id})">
                                Ver Propuesta
                            </button>
                        </div>
                    `;
                }).join('') : '<div class="empty-state" style="padding: 30px;">No hay propuestas recibidas</div>';
                
            } else if (currentUser.role === 'vendedor') {
                const avisosActivos = data.avisos.filter(a => a.userId !== currentUser.id && a.estado === 'abierto');
                const misPropuestas = data.propuestas.filter(p => p.vendedorId === currentUser.id);
                const chatsActivos = data.chats.filter(c => 
                    c.participantes.includes(currentUser.id) && c.activo
                );
                const propuestasAceptadas = misPropuestas.filter(p => p.estado === 'aceptada');
                
                document.getElementById('stat-avisos-activos').textContent = avisosActivos.length;
                document.getElementById('stat-propuestas-total').textContent = misPropuestas.length;
                document.getElementById('stat-chats-activos').textContent = chatsActivos.length;
                document.getElementById('stat-negociaciones').textContent = propuestasAceptadas.length;
                
                // Avisos recientes
                const avisosContainer = document.getElementById('dashboard-avisos');
                const avisosRecientes = avisosActivos.slice(0, 4);
                
                avisosContainer.innerHTML = avisosRecientes.length > 0 ? avisosRecientes.map(aviso => {
                    const user = data.users.find(u => u.id === aviso.userId);
                    
                    // Icono seg√∫n tipo
                    const tipoIcon = {
                        'inmueble': 'üè†',
                        'auto': 'üöó',
                        'motos': 'üèçÔ∏è',
                        'tecnologia': 'üíª',
                        'servicios': 'üîß',
                        'otros': 'üì¶'
                    }[aviso.tipo] || 'üìã';
                    
                    // Informaci√≥n espec√≠fica para inmuebles
                    let infoExtra = '';
                    if (aviso.tipo === 'inmueble') {
                        infoExtra = `
                            <div style="font-size: 0.9rem; color: var(--gray); margin: 8px 0;">
                                ${aviso.tipoInmueble} en ${aviso.comuna}
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="aviso-card" onclick="verDetalleAviso(${aviso.id})">
                            <div class="aviso-title">${aviso.titulo.substring(0, 40)}...</div>
                            ${infoExtra}
                            <div style="margin: 15px 0;">
                                <div style="font-size: 1.2rem; font-weight: 800; color: var(--primary);">
                                    $${aviso.presupuesto.toLocaleString()}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--gray);">
                                    ${tipoIcon} De: ${user.name || user.email}
                                </div>
                            </div>
                            <button class="btn btn-sm btn-secondary btn-block" onclick="event.stopPropagation(); mostrarEnviarPropuesta(${aviso.id})">
                                Enviar Propuesta
                            </button>
                        </div>
                    `;
                }).join('') : '<div class="empty-state" style="padding: 30px;">No hay avisos disponibles</div>';
                
                // Propuestas recientes
                const propuestasContainer = document.getElementById('dashboard-propuestas');
                const propuestasRecientes = misPropuestas.slice(0, 4);
                
                propuestasContainer.innerHTML = propuestasRecientes.length > 0 ? propuestasRecientes.map(propuesta => {
                    const aviso = data.avisos.find(a => a.id === propuesta.avisoId);
                    
                    // Icono seg√∫n tipo
                    const tipoIcon = {
                        'inmueble': 'üè†',
                        'auto': 'üöó',
                        'motos': 'üèçÔ∏è',
                        'tecnologia': 'üíª',
                        'servicios': 'üîß',
                        'otros': 'üì¶'
                    }[aviso.tipo] || 'üìã';
                    
                    return `
                        <div class="propuesta-card" onclick="verDetalleAviso(${aviso.id})">
                            <div style="font-weight: 700; margin-bottom: 10px;">${tipoIcon} ${aviso.titulo.substring(0, 30)}...</div>
                            <div style="display: flex; gap: 10px; margin: 10px 0;">
                                <span class="badge ${propuesta.estado === 'pendiente' ? 'badge-warning' : 
                                                  propuesta.estado === 'aceptada' ? 'badge-success' : 'badge-danger'}">
                                    ${propuesta.estado}
                                </span>
                                <span style="font-size: 1.1rem; font-weight: 800; color: var(--primary);">
                                    $${propuesta.precio.toLocaleString()}
                                </span>
                            </div>
                            <button class="btn btn-sm btn-primary btn-block" onclick="event.stopPropagation(); verDetalleAviso(${aviso.id})">
                                Ver Detalles
                            </button>
                        </div>
                    `;
                }).join('') : '<div class="empty-state" style="padding: 30px;">No has enviado propuestas</div>';
            }
        }

        function refreshDashboard() {
            updateDashboard();
            showToast('Dashboard actualizado', 'success');
        }

        // ============================================
        // FUNCIONES DE PERFIL
        // ============================================
        function loadProfile() {
            const data = getData();
            const container = document.getElementById('profile-content');
            
            // Obtener estad√≠sticas del usuario
            const avisosCount = data.avisos.filter(a => a.userId === currentUser.id).length;
            const propuestasCount = data.propuestas.filter(p => p.vendedorId === currentUser.id).length;
            const chatsCount = data.chats.filter(c => c.participantes.includes(currentUser.id)).length;
            
            // Calcular rating promedio
            const rating = currentUser.rating || 5.0;
            
            // Calcular estad√≠sticas por tipo de aviso
            const avisosInmuebles = data.avisos.filter(a => a.userId === currentUser.id && a.tipo === 'inmueble').length;
            const avisosAutos = data.avisos.filter(a => a.userId === currentUser.id && a.tipo === 'auto').length;
            const avisosMotos = data.avisos.filter(a => a.userId === currentUser.id && a.tipo === 'motos').length;
            
            container.innerHTML = `
                <div style="display: flex; align-items: center; gap: 30px; margin-bottom: 40px; flex-wrap: wrap;">
                    <div class="user-avatar" style="width: 100px; height: 100px; font-size: 2.5rem; background: ${currentUser.avatarColor}">
                        ${(currentUser.name || currentUser.email).charAt(0).toUpperCase()}
                    </div>
                    <div style="flex: 1;">
                        <h2 style="margin-bottom: 10px; font-size: 2rem;">${currentUser.name || currentUser.email}</h2>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div class="badge ${currentUser.role === 'comprador' ? 'badge-info' : 
                                              currentUser.role === 'vendedor' ? 'badge-success' : 'badge-warning'}" 
                                 style="font-size: 1rem; padding: 8px 16px;">
                                ${currentUser.role === 'comprador' ? 'Comprador' : 
                                  currentUser.role === 'vendedor' ? 'Vendedor' : 'Administrador'}
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-weight: 700; color: var(--warning);">‚òÖ</span>
                                <span style="font-weight: 700;">${rating.toFixed(1)}</span>
                                <span style="color: var(--gray); font-size: 0.9rem;">/5.0</span>
                            </div>
                        </div>
                        <div style="color: var(--gray);">
                            Miembro desde ${new Date(currentUser.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px;">
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary); margin-bottom: 10px;">
                            ${avisosCount}
                        </div>
                        <div style="color: var(--gray); font-weight: 600;">Avisos Publicados</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary); margin-bottom: 10px;">
                            ${propuestasCount}
                        </div>
                        <div style="color: var(--gray); font-weight: 600;">Propuestas ${currentUser.role === 'vendedor' ? 'Enviadas' : 'Recibidas'}</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary); margin-bottom: 10px;">
                            ${chatsCount}
                        </div>
                        <div style="color: var(--gray); font-weight: 600;">Conversaciones</div>
                    </div>
                </div>
                
                ${currentUser.role === 'comprador' && avisosCount > 0 ? `
                    <div style="margin-bottom: 40px;">
                        <h3 style="margin-bottom: 25px; font-size: 1.5rem;">Distribuci√≥n de Avisos por Categor√≠a</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            ${avisosInmuebles > 0 ? `
                                <div class="badge badge-info" style="font-size: 1rem; padding: 10px 20px;">
                                    üè† Inmuebles: ${avisosInmuebles}
                                </div>
                            ` : ''}
                            ${avisosAutos > 0 ? `
                                <div class="badge badge-info" style="font-size: 1rem; padding: 10px 20px;">
                                    üöó Automotor: ${avisosAutos}
                                </div>
                            ` : ''}
                            ${avisosMotos > 0 ? `
                                <div class="badge badge-info" style="font-size: 1rem; padding: 10px 20px;">
                                    üèçÔ∏è Motos: ${avisosMotos}
                                </div>
                            ` : ''}
                            ${avisosCount - (avisosInmuebles + avisosAutos + avisosMotos) > 0 ? `
                                <div class="badge badge-info" style="font-size: 1rem; padding: 10px 20px;">
                                    üì¶ Otros: ${avisosCount - (avisosInmuebles + avisosAutos + avisosMotos)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 25px; font-size: 1.5rem;">Informaci√≥n de la cuenta</h3>
                    <div class="detalle-meta-grid">
                        <div class="meta-card">
                            <div class="meta-label">Email</div>
                            <div class="meta-value">${currentUser.email}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">ID de usuario</div>
                            <div class="meta-value">${currentUser.id}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">Tipo de cuenta</div>
                            <div class="meta-value">${currentUser.role === 'comprador' ? 'Comprador' : 'Vendedor'}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 25px; font-size: 1.5rem;">Configuraci√≥n de cuenta</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-outline" onclick="cambiarPassword()">
                            üîí Cambiar contrase√±a
                        </button>
                        <button class="btn btn-outline" onclick="editarPerfil()">
                            ‚úèÔ∏è Editar informaci√≥n personal
                        </button>
                        <button class="btn btn-outline" onclick="exportarDatos()">
                            üì• Exportar mis datos
                        </button>
                        ${currentUser.role === 'vendedor' ? `
                            <button class="btn btn-outline" onclick="verHistorialVentas()">
                                üìä Ver historial de ventas
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function editarPerfil() {
            showToast('Funci√≥n de edici√≥n de perfil en desarrollo', 'info');
        }

        function cambiarPassword() {
            const nuevaPassword = prompt('Ingresa tu nueva contrase√±a (m√≠nimo 6 caracteres):');
            if (nuevaPassword && nuevaPassword.length >= 6) {
                const data = getData();
                const user = data.users.find(u => u.id === currentUser.id);
                user.password = nuevaPassword;
                saveData(data);
                showToast('Contrase√±a actualizada exitosamente', 'success');
            } else if (nuevaPassword) {
                showToast('La contrase√±a debe tener al menos 6 caracteres', 'error');
            }
        }

        function exportarDatos() {
            const data = getData();
            const userData = {
                usuario: currentUser,
                avisos: data.avisos.filter(a => a.userId === currentUser.id),
                propuestas: currentUser.role === 'vendedor' ? 
                    data.propuestas.filter(p => p.vendedorId === currentUser.id) :
                    data.propuestas.filter(p => 
                        data.avisos.some(a => a.id === p.avisoId && a.userId === currentUser.id)
                    ),
                chats: data.chats.filter(c => c.participantes.includes(currentUser.id)),
                notifications: data.notifications.filter(n => n.userId === currentUser.id)
            };
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `marketconnect_${currentUser.email}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Datos exportados exitosamente', 'success');
        }

        // ============================================
        // FUNCIONES DEL PANEL ADMIN
        // ============================================
        function loadAdminPanel() {
            const data = getData();
            
            // Actualizar estad√≠sticas
            document.getElementById('admin-total-users').textContent = data.users.length;
            document.getElementById('admin-total-avisos').textContent = data.avisos.length;
            document.getElementById('admin-total-propuestas').textContent = data.propuestas.length;
            document.getElementById('admin-total-chats').textContent = data.chats.length;
            
            // Usuarios
            const usersList = document.getElementById('admin-users-list');
            usersList.innerHTML = data.users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="user-avatar" style="width: 32px; height: 32px; font-size: 0.9rem; background: ${user.avatarColor}">
                                ${(user.name || user.email).charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${user.email}</div>
                                <div style="font-size: 0.85rem; color: var(--gray);">${user.name || 'Sin nombre'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.name || '-'}</td>
                    <td><span class="badge ${user.role === 'admin' ? 'badge-warning' : user.role === 'vendedor' ? 'badge-success' : 'badge-info'}">${user.role}</span></td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td>${user.totalAvisos || 0}</td>
                    <td>${user.totalPropuestas || 0}</td>
                    <td>
                        <button class="btn btn-xs" onclick="eliminarUsuarioAdmin(${user.id})" ${user.id === currentUser.id ? 'disabled' : ''}>Eliminar</button>
                    </td>
                </tr>
            `).join('');
            
            // Avisos
            const avisosList = document.getElementById('admin-avisos-list');
            avisosList.innerHTML = data.avisos.map(aviso => {
                const user = data.users.find(u => u.id === aviso.userId);
                const propuestasCount = aviso.propuestas ? aviso.propuestas.length : 0;
                
                return `
                    <tr>
                        <td>${aviso.id}</td>
                        <td>
                            <div style="font-weight: 600;">${aviso.titulo.substring(0, 30)}...</div>
                            <div style="font-size: 0.85rem; color: var(--gray);">${aviso.tipo}</div>
                        </td>
                        <td>${aviso.tipo}</td>
                        <td>${user?.email || 'Desconocido'}</td>
                        <td>$${aviso.presupuesto.toLocaleString()}</td>
                        <td><span class="badge ${aviso.estado === 'abierto' ? 'badge-success' : aviso.estado === 'negociando' ? 'badge-warning' : 'badge-info'}">${aviso.estado}</span></td>
                        <td>${propuestasCount}</td>
                        <td>
                            <button class="btn btn-xs" onclick="eliminarAvisoAdmin(${aviso.id})">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Propuestas
            const propuestasList = document.getElementById('admin-propuestas-list');
            propuestasList.innerHTML = data.propuestas.map(propuesta => {
                const aviso = data.avisos.find(a => a.id === propuesta.avisoId);
                const vendedor = data.users.find(u => u.id === propuesta.vendedorId);
                
                return `
                    <tr>
                        <td>${propuesta.id}</td>
                        <td>
                            <div style="font-weight: 600;">${aviso?.titulo.substring(0, 30) || 'Aviso eliminado'}...</div>
                        </td>
                        <td>${vendedor?.email || 'Desconocido'}</td>
                        <td>$${propuesta.precio.toLocaleString()}</td>
                        <td><span class="badge ${propuesta.estado === 'pendiente' ? 'badge-warning' : propuesta.estado === 'aceptada' ? 'badge-success' : 'badge-danger'}">${propuesta.estado}</span></td>
                        <td>${new Date(propuesta.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-xs" onclick="eliminarPropuestaAdmin(${propuesta.id})">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function eliminarUsuarioAdmin(userId) {
            if (userId === currentUser.id) {
                showToast('No puedes eliminarte a ti mismo', 'error');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de eliminar este usuario? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            const data = getData();
            
            // Eliminar avisos del usuario
            data.avisos = data.avisos.filter(a => a.userId !== userId);
            
            // Eliminar propuestas del usuario
            data.propuestas = data.propuestas.filter(p => p.vendedorId !== userId);
            
            // Eliminar usuario
            data.users = data.users.filter(u => u.id !== userId);
            
            // Eliminar chats del usuario
            data.chats = data.chats.filter(c => !c.participantes.includes(userId));
            
            saveData(data);
            showToast('Usuario eliminado exitosamente', 'success');
            loadAdminPanel();
        }

        function eliminarAvisoAdmin(avisoId) {
            if (!confirm('¬øEst√°s seguro de eliminar este aviso? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            const data = getData();
            
            // Eliminar propuestas asociadas
            data.propuestas = data.propuestas.filter(p => p.avisoId !== avisoId);
            
            // Eliminar chats asociados
            data.chats = data.chats.filter(c => c.avisoId !== avisoId);
            
            // Eliminar aviso
            data.avisos = data.avisos.filter(a => a.id !== avisoId);
            
            saveData(data);
            showToast('Aviso eliminado exitosamente', 'success');
            loadAdminPanel();
        }

        function eliminarPropuestaAdmin(propuestaId) {
            if (!confirm('¬øEst√°s seguro de eliminar esta propuesta? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            const data = getData();
            const propuesta = data.propuestas.find(p => p.id === propuestaId);
            
            if (propuesta) {
                // Eliminar de la lista de propuestas del aviso
                const aviso = data.avisos.find(a => a.id === propuesta.avisoId);
                if (aviso && aviso.propuestas) {
                    const index = aviso.propuestas.indexOf(propuestaId);
                    if (index > -1) {
                        aviso.propuestas.splice(index, 1);
                    }
                }
                
                // Eliminar chat asociado
                data.chats = data.chats.filter(c => c.propuestaId !== propuestaId);
                
                // Eliminar propuesta
                data.propuestas = data.propuestas.filter(p => p.id !== propuestaId);
                
                saveData(data);
                showToast('Propuesta eliminada exitosamente', 'success');
                loadAdminPanel();
            }
        }

        function generarReporte() {
            const data = getData();
            
            const reporte = {
                fecha: new Date().toISOString(),
                totalUsuarios: data.users.length,
                totalAvisos: data.avisos.length,
                totalPropuestas: data.propuestas.length,
                totalChats: data.chats.length,
                usuariosPorRol: {
                    compradores: data.users.filter(u => u.role === 'comprador').length,
                    vendedores: data.users.filter(u => u.role === 'vendedor').length,
                    administradores: data.users.filter(u => u.role === 'admin').length
                },
                avisosPorTipo: {
                    inmueble: data.avisos.filter(a => a.tipo === 'inmueble').length,
                    auto: data.avisos.filter(a => a.tipo === 'auto').length,
                    motos: data.avisos.filter(a => a.tipo === 'motos').length,
                    tecnologia: data.avisos.filter(a => a.tipo === 'tecnologia').length,
                    servicios: data.avisos.filter(a => a.tipo === 'servicios').length,
                    otros: data.avisos.filter(a => a.tipo === 'otros').length
                },
                avisosPorEstado: {
                    abierto: data.avisos.filter(a => a.estado === 'abierto').length,
                    negociando: data.avisos.filter(a => a.estado === 'negociando').length,
                    cerrado: data.avisos.filter(a => a.estado === 'cerrado').length,
                    rechazado: data.avisos.filter(a => a.estado === 'rechazado').length
                }
            };
            
            const dataStr = JSON.stringify(reporte, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_admin_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Reporte generado exitosamente', 'success');
        }

        function resetSystem() {
            if (!confirm('¬øEST√ÅS SEGURO DE RESETEAR EL SISTEMA? Esta acci√≥n eliminar√° todos los datos excepto las cuentas de administrador y no se puede deshacer.')) {
                return;
            }
            
            const data = getData();
            
            // Guardar solo los usuarios administradores
            const adminUsers = data.users.filter(u => u.role === 'admin');
            
            // Crear nuevos datos iniciales
            const newData = {
                users: adminUsers,
                avisos: [],
                propuestas: [],
                chats: [],
                notifications: [],
                nextIds: {
                    users: adminUsers.length + 1,
                    avisos: 1,
                    propuestas: 1,
                    chats: 1,
                    notifications: 1
                }
            };
            
            // A√±adir usuarios de demo
            const demoUsers = [
                { 
                    id: newData.nextIds.users++, 
                    email: "comprador@demo.com", 
                    password: "123456", 
                    name: "Juan Comprador",
                    role: "comprador", 
                    createdAt: new Date().toISOString(),
                    avatarColor: "#4361ee",
                    rating: 4.8,
                    totalAvisos: 0,
                    totalPropuestas: 0
                },
                { 
                    id: newData.nextIds.users++, 
                    email: "vendedor@demo.com", 
                    password: "123456", 
                    name: "Mar√≠a Vendedora",
                    role: "vendedor", 
                    createdAt: new Date().toISOString(),
                    avatarColor: "#7209b7",
                    rating: 4.9,
                    totalAvisos: 0,
                    totalPropuestas: 0
                }
            ];
            
            newData.users.push(...demoUsers);
            saveData(newData);
            
            // Recargar p√°gina
            location.reload();
        }

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hidden');
        }

        function scrollToFeatures() {
            const featuresSection = document.getElementById('features-section');
            if (featuresSection) {
                featuresSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function showPasswordReset() {
            showToast('Funci√≥n de recuperaci√≥n de contrase√±a en desarrollo', 'info');
        }

        function verHistorialVentas() {
            showToast('Historial de ventas en desarrollo', 'info');
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticaci√≥n al cargar
            checkAuth();
            
            // Cargar regiones en los formularios
            cargarRegiones('aviso-region');
            cargarRegiones('filter-inmueble-region');
            
            // A√±adir CSS para fadeOut
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        });

        // ============================================
        // PWA INSTALL PROMPT
        // ============================================
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-pwa').classList.remove('hidden');
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-pwa').classList.add('hidden');
                }
                deferredPrompt = null;
            }
        });
    </script>
</body>
</html>
