<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>BuscaReal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f4f4f4}
header{background:#000;color:#fff;padding:15px;font-weight:600}
nav button{margin-right:10px}
main{padding:20px}
.card{background:#fff;border-radius:10px;padding:20px;max-width:900px;margin:auto;margin-bottom:20px}
button{padding:10px 15px;border:none;border-radius:6px;background:#000;color:#fff;cursor:pointer}
input,select,textarea{width:100%;padding:10px;margin-top:8px;margin-bottom:15px}
.hidden{display:none}
.list{border-bottom:1px solid #ddd;padding:10px 0}
.badge{padding:4px 8px;border-radius:6px;font-size:12px}
.ok{background:#c8f7c5}
.warn{background:#ffeaa7}
.chat{border:1px solid #ccc;height:200px;overflow:auto;padding:10px;margin-bottom:10px}
.msg{margin-bottom:5px}
</style>
</head>

<body>

<header>
BuscaReal
<span id="userInfo"></span>
</header>

<main id="app"></main>

<script>
/* ---------- BASE ---------- */
const db = JSON.parse(localStorage.getItem("buscareal")) || {
 users: [],
 searches: [],
 proposals: [],
 chats: []
};
const save=()=>localStorage.setItem("buscareal",JSON.stringify(db));
let session = JSON.parse(localStorage.getItem("session"));

/* ---------- ROUTER ---------- */
function render(view){document.getElementById("app").innerHTML=view}

/* ---------- AUTH ---------- */
function login(){
 const email=document.getElementById("email").value;
 const role=document.getElementById("role").value;
 let u=db.users.find(u=>u.email===email);
 if(!u){u={id:Date.now(),email,role,verified:true,reputation:5};db.users.push(u);save()}
 session=u;localStorage.setItem("session",JSON.stringify(u));dashboard()
}

function logout(){localStorage.clear();location.reload()}

/* ---------- DASHBOARD ---------- */
function dashboard(){
 if(!session) return home();
 document.getElementById("userInfo").innerHTML=" | "+session.email+" ("+session.role+")";
 let menu=`
 <nav>
 <button onclick="dashboard()">Inicio</button>
 <button onclick="searches()">Búsquedas</button>
 ${session.role==="buyer"?'<button onclick="newSearch()">Publicar</button>':''}
 <button onclick="messages()">Mensajes</button>
 <button onclick="logout()">Salir</button>
 </nav>`;
 render(menu + `<div class="card"><h2>Bienvenido</h2>
 <p>Reputación: ⭐ ${session.reputation}</p></div>`);
}

/* ---------- HOME ---------- */
function home(){
 render(`<div class="card">
 <h2>Marketplace Inverso</h2>
 <p>Publica lo que buscas y recibe propuestas reales.</p>
 <input id="email" placeholder="Email">
 <select id="role">
 <option value="buyer">Comprador</option>
 <option value="seller">Vendedor</option>
 </select>
 <button onclick="login()">Entrar</button>
 </div>`);
}

/* ---------- SEARCHES ---------- */
function newSearch(){
 render(`<div class="card">
 <h2>Nueva Búsqueda</h2>
 <input id="type" placeholder="Tipo (Depto, Casa)">
 <input id="loc" placeholder="Ubicación">
 <input id="budget" placeholder="Presupuesto">
 <select id="urgency"><option>Alta</option><option>Media</option></select>
 <button onclick="saveSearch()">Publicar</button>
 </div>`);
}

function saveSearch(){
 db.searches.push({
  id:Date.now(),
  buyer:session.email,
  type:type.value,
  loc:loc.value,
  budget:budget.value,
  urgency:urgency.value,
  status:"Activa"
 });
 save();searches()
}

function searches(){
 let list=db.searches.map(s=>`
 <div class="list">
 <b>${s.type}</b> - ${s.loc} - ${s.budget}
 <span class="badge ok">${s.status}</span>
 ${session.role==="seller"?`<button onclick="propose(${s.id})">Proponer</button>`:""}
 </div>`).join("");
 render(`<div class="card"><h2>Búsquedas</h2>${list}</div>`);
}

/* ---------- PROPOSALS ---------- */
function propose(id){
 render(`<div class="card">
 <h2>Enviar propuesta</h2>
 <textarea id="msg"></textarea>
 <button onclick="sendProp(${id})">Enviar</button>
 </div>`);
}

function sendProp(id){
 db.proposals.push({
  id:Date.now(),
  search:id,
  seller:session.email,
  msg:msg.value
 });
 save();searches()
}

/* ---------- CHAT ---------- */
function messages(){
 let props=db.proposals.filter(p=>session.role==="seller"?p.seller===session.email:true);
 let list=props.map(p=>`
 <div class="list">
 Propuesta #${p.id}
 <button onclick="chat(${p.id})">Chat</button>
 </div>`).join("");
 render(`<div class="card"><h2>Mensajes</h2>${list}</div>`);
}

function chat(id){
 let chat=db.chats.find(c=>c.id===id)||{id,logs:[]};
 render(`<div class="card">
 <div class="chat" id="chatBox">${chat.logs.map(l=>`<div class="msg">${l}</div>`).join("")}</div>
 <input id="cmsg">
 <button onclick="sendMsg(${id})">Enviar</button>
 </div>`);
}

function sendMsg(id){
 let chat=db.chats.find(c=>c.id===id);
 if(!chat){chat={id,logs:[]};db.chats.push(chat)}
 chat.logs.push(session.email+": "+cmsg.value);
 save();chat(id)
}

/* ---------- INIT ---------- */
session?dashboard():home();
</script>

</body>
</html>
